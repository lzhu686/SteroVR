<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒç›®RGBç›¸æœº å®æ—¶æ˜¾ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #868e96);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(220, 53, 69, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            text-align: center;
        }

        .status-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
        }

        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .video-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .video-panel h3 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .video-frame {
            width: 100%;
            height: auto;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            background: #000;
            min-height: 300px;
            object-fit: cover;
        }

        .video-frame:hover {
            border-color: #28a745;
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.3);
        }

        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: linear-gradient(45deg, #333, #555);
            color: #ccc;
            font-size: 1.2em;
            border-radius: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .status-connected {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .status-disconnected {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            color: white;
        }

        .status-connecting {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: white;
        }

        .logs-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 200px;
            overflow-y: auto;
        }

        .logs-panel h3 {
            margin-bottom: 15px;
            color: #fff;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }

        .log-info { color: #17a2b8; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }
        .log-success { color: #28a745; }

        .quality-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .quality-control label {
            font-weight: bold;
        }

        .quality-control input[type="range"] {
            width: 200px;
            height: 5px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
        }

        .quality-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #28a745;
            cursor: pointer;
            border: 2px solid #fff;
        }

        @media (max-width: 768px) {
            .video-container {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
        }

        .fps-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #28a745;
            padding: 5px 10px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            font-weight: bold;
            white-space: nowrap;
            min-width: 100px;
        }

        .metadata-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-family: 'Courier New', monospace;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .video-panel:hover .metadata-panel {
            opacity: 1;
        }

        .video-wrapper {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">æ–­å¼€è¿æ¥</div>
    
    <div class="header">
        <h1>ğŸ¥ åŒç›®RGBç›¸æœº</h1>
        <p>å®æ—¶ç«‹ä½“è§†è§‰ â€¢ å·¦å³åŒç›®å›¾åƒæ˜¾ç¤º</p>
    </div>

    <div class="container">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <button class="btn btn-primary" id="connectBtn" onclick="connectWebSocket()">
                ğŸ”Œ è¿æ¥ä¼ æ„Ÿå™¨
            </button>
            <button class="btn btn-secondary" id="disconnectBtn" onclick="disconnectWebSocket()" disabled>
                ğŸ”Œ æ–­å¼€è¿æ¥
            </button>
            <button class="btn btn-secondary" id="saveBtn" onclick="saveCurrentFrames()" disabled>
                ğŸ’¾ ä¿å­˜å›¾åƒ
            </button>
            <button class="btn btn-danger" id="clearLogsBtn" onclick="clearLogs()">
                ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
            </button>
        </div>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="status-panel">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">è¿æ¥çŠ¶æ€</div>
                    <div class="status-value" id="statusValue">ç¦»çº¿</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æœåŠ¡å™¨å¸§ç‡</div>
                    <div class="status-value" id="fpsValue">0 FPS</div>
                </div>
                <div class="status-item">
                    <div class="status-label">æ€»å¸§æ•°</div>
                    <div class="status-value" id="frameCountValue">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">å‹ç¼©ç‡</div>
                    <div class="status-value" id="compressionValue">0%</div>
                </div>
                <div class="status-item">
                    <div class="status-label">åˆ†è¾¨ç‡</div>
                    <div class="status-value" id="resolutionValue">0x0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">å»¶è¿Ÿ</div>
                    <div class="status-value" id="latencyValue">0ms</div>
                </div>
            </div>
            
            <!-- è´¨é‡æ§åˆ¶ -->
            <div class="quality-control">
                <label for="qualitySlider">å›¾åƒè´¨é‡:</label>
                <input type="range" id="qualitySlider" min="30" max="95" value="80" oninput="updateQuality()">
                <span id="qualityValue">80%</span>
            </div>
        </div>

        <!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="video-container">
            <!-- å·¦ç›¸æœº -->
            <div class="video-panel">
                <h3>ğŸ¯ å·¦ç›¸æœº (Left)</h3>
                <div class="video-wrapper">
                    <div class="placeholder" id="leftPlaceholder">
                        ç­‰å¾…å·¦ç›¸æœºæ•°æ®...
                    </div>
                    <img class="video-frame" id="leftIRFrame" style="display: none;" alt="å·¦ç›¸æœº">
                    <div class="fps-indicator" id="leftFPS">å®¢æˆ·ç«¯: 0 FPS</div>
                    <div class="metadata-panel" id="leftMetadata">
                        ä½ç½®: ç›¸æœºå·¦ä¾§ â€¢ ç”¨é€”: ç«‹ä½“è§†è§‰å·¦è§†å›¾
                    </div>
                </div>
            </div>

            <!-- å³ç›¸æœº -->
            <div class="video-panel">
                <h3>ğŸ¯ å³ç›¸æœº (Right)</h3>
                <div class="video-wrapper">
                    <div class="placeholder" id="rightPlaceholder">
                        ç­‰å¾…å³ç›¸æœºæ•°æ®...
                    </div>
                    <img class="video-frame" id="rightIRFrame" style="display: none;" alt="å³ç›¸æœº">
                    <div class="fps-indicator" id="rightFPS">å®¢æˆ·ç«¯: 0 FPS</div>
                    <div class="metadata-panel" id="rightMetadata">
                        ä½ç½®: ç›¸æœºå³ä¾§ â€¢ ç”¨é€”: ç«‹ä½“è§†è§‰å³è§†å›¾
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="logs-panel">
            <h3>ğŸ“ ç³»ç»Ÿæ—¥å¿—</h3>
            <div id="logsContainer"></div>
        </div>
    </div>

    <script>
        // WebSocketè¿æ¥ç®¡ç†
        let websocket = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let frameCount = 0;
        let startTime = Date.now();
        let lastFrameTime = 0;

        // æ€§èƒ½ç»Ÿè®¡
        let stats = {
            totalFrames: 0,
            totalBytes: 0,
            lastFPSUpdate: Date.now(),
            framesSinceLastUpdate: 0,
            lastFrameId: -1,  // è·Ÿè¸ªä¸Šä¸€å¸§çš„çœŸå®å¸§IDï¼ˆæ›¿æ¢lastFrameNumberï¼‰
            duplicateFrames: 0,  // é‡å¤å¸§è®¡æ•°
            droppedFrames: 0  // ä¸¢å¸§è®¡æ•°
        };

        // WebSocketæœåŠ¡å™¨é…ç½®
        const WS_HOST = window.location.hostname || 'localhost';
        const WS_PORT = 8765;
        // ä½¿ç”¨å®‰å…¨çš„WebSocketè¿æ¥ (wss://) å½“é¡µé¢é€šè¿‡HTTPSåŠ è½½æ—¶
        const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${WS_PROTOCOL}//${WS_HOST}:${WS_PORT}`;

        // UIå…ƒç´ 
        const elements = {
            connectionStatus: document.getElementById('connectionStatus'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            saveBtn: document.getElementById('saveBtn'),
            statusValue: document.getElementById('statusValue'),
            fpsValue: document.getElementById('fpsValue'),
            frameCountValue: document.getElementById('frameCountValue'),
            compressionValue: document.getElementById('compressionValue'),
            resolutionValue: document.getElementById('resolutionValue'),
            latencyValue: document.getElementById('latencyValue'),
            leftIRFrame: document.getElementById('leftIRFrame'),
            rightIRFrame: document.getElementById('rightIRFrame'),
            leftPlaceholder: document.getElementById('leftPlaceholder'),
            rightPlaceholder: document.getElementById('rightPlaceholder'),
            leftFPS: document.getElementById('leftFPS'),
            rightFPS: document.getElementById('rightFPS'),
            leftMetadata: document.getElementById('leftMetadata'),
            rightMetadata: document.getElementById('rightMetadata'),
            logsContainer: document.getElementById('logsContainer'),
            qualitySlider: document.getElementById('qualitySlider'),
            qualityValue: document.getElementById('qualityValue')
        };

        // è¿æ¥WebSocket
        function connectWebSocket() {
            if (isConnected) return;

            addLog('æ­£åœ¨è¿æ¥åˆ°åŒç›®ç›¸æœº...', 'info');
            updateConnectionStatus('connecting');
            
            try {
                websocket = new WebSocket(WS_URL);
                
                websocket.onopen = function(event) {
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus('connected');
                    updateButtons();
                    addLog('âœ… WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                    startTime = Date.now();
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        addLog(`âŒ è§£ææ¶ˆæ¯å¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                websocket.onclose = function(event) {
                    isConnected = false;
                    updateConnectionStatus('disconnected');
                    updateButtons();
                    hideFrames();
                    
                    if (event.wasClean) {
                        addLog('ğŸ”Œ WebSocketè¿æ¥å·²æ­£å¸¸å…³é—­', 'info');
                    } else {
                        addLog(`âŒ WebSocketè¿æ¥å¼‚å¸¸æ–­å¼€ (code: ${event.code})`, 'error');
                        attemptReconnect();
                    }
                };
                
                websocket.onerror = function(error) {
                    addLog(`âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                addLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // æ–­å¼€WebSocketè¿æ¥
        function disconnectWebSocket() {
            if (websocket && isConnected) {
                websocket.close(1000, 'User initiated disconnect');
                addLog('ğŸ”Œ ç”¨æˆ·æ–­å¼€è¿æ¥', 'info');
            }
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connection_established':
                    handleConnectionEstablished(data);
                    break;
                case 'dual_infrared_frame':
                    handleDualInfraredFrame(data);
                    break;
                default:
                    addLog(`â“ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${data.type}`, 'warning');
            }
        }

        // å¤„ç†è¿æ¥å»ºç«‹æ¶ˆæ¯
        function handleConnectionEstablished(data) {
            const { camera_info, server_info } = data;
            addLog(`ğŸ¥ ç›¸æœºä¿¡æ¯: ${camera_info.width}x${camera_info.height} @${camera_info.fps}fps`, 'success');
            addLog(`ğŸ–¥ï¸ æœåŠ¡å™¨ç‰ˆæœ¬: ${server_info.version}`, 'info');
            
            // æ›´æ–°åˆ†è¾¨ç‡æ˜¾ç¤º
            elements.resolutionValue.textContent = `${camera_info.width}x${camera_info.height}`;
        }

        // å¤„ç†åŒçº¢å¤–å¸§æ•°æ®
        function handleDualInfraredFrame(data) {
            const { left_infrared, right_infrared, metadata, stats: serverStats, timestamp, frame_id } = data;

            // ä½¿ç”¨çœŸå®çš„frame_idè¿›è¡Œæ—¥å¿—è®°å½•
            console.log(`[Frame Received] å¸§ID: ${frame_id}, æœåŠ¡å™¨é‡‡é›†FPS: ${serverStats.fps_actual}, å‘é€FPS: ${serverStats.fps_sent || 'N/A'}`);

            // æ›´æ–°å›¾åƒ
            if (left_infrared && right_infrared) {
                updateInfraredFrame('left', left_infrared, metadata);
                updateInfraredFrame('right', right_infrared, metadata);

                frameCount++;
                stats.totalFrames++;

                // è®¡ç®—å»¶è¿Ÿ
                const currentTime = Date.now();
                const latency = currentTime - (timestamp * 1000);
                elements.latencyValue.textContent = `${Math.round(latency)}ms`;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                updateStats(serverStats, metadata);
                updateFrameRate(frame_id);  // ä½¿ç”¨çœŸå®çš„frame_id
            }
        }

        // æ›´æ–°çº¢å¤–å›¾åƒ
        function updateInfraredFrame(side, base64Data, metadata) {
            const frameElement = elements[`${side}IRFrame`];
            const placeholderElement = elements[`${side}Placeholder`];
            const fpsElement = elements[`${side}FPS`];
            const metadataElement = elements[`${side}Metadata`];
            
            // æ˜¾ç¤ºå›¾åƒ
            frameElement.src = `data:image/jpeg;base64,${base64Data}`;
            frameElement.style.display = 'block';
            placeholderElement.style.display = 'none';
            
            // æ›´æ–°å…ƒæ•°æ®
            if (metadata) {
                const sideText = side === 'left' ? 'å·¦ä¾§' : 'å³ä¾§';
                const encodeTime = metadata.encode_time_ms ? ` â€¢ ç¼–ç : ${metadata.encode_time_ms}ms` : '';
                metadataElement.innerHTML = `
                    ä½ç½®: ç›¸æœº${sideText} â€¢ åˆ†è¾¨ç‡: ${metadata.width}x${metadata.height}<br>
                    è´¨é‡: ${metadata.quality}% â€¢ å‹ç¼©ç‡: ${(metadata.compression_ratio * 100).toFixed(1)}%<br>
                    å¤§å°: ${(metadata.compressed_size / 1024).toFixed(1)} KB${encodeTime}
                `;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(serverStats, metadata) {
            elements.frameCountValue.textContent = serverStats.frames_captured || frameCount;

            // æ˜¾ç¤ºæœåŠ¡å™¨å‘é€FPSï¼ˆä¼˜å…ˆï¼‰æˆ–é‡‡é›†FPS
            const displayFPS = serverStats.fps_sent || serverStats.fps_actual || 0;
            elements.fpsValue.textContent = `${displayFPS} FPS`;

            // ä¿®å¤ï¼šæ­£ç¡®è·å–å‹ç¼©ç‡æ•°æ®
            if (metadata && metadata.compression_ratio !== undefined) {
                elements.compressionValue.textContent = `${(metadata.compression_ratio * 100).toFixed(1)}%`;
            } else if (serverStats.compression_ratio !== undefined) {
                elements.compressionValue.textContent = `${(serverStats.compression_ratio * 100).toFixed(1)}%`;
            }
        }

        // æ›´æ–°å¸§ç‡æ˜¾ç¤ºï¼ˆå®¢æˆ·ç«¯æ¥æ”¶å¸§ç‡ - åªç»Ÿè®¡å”¯ä¸€å¸§ï¼‰
        function updateFrameRate(frameId) {
            // æ£€æµ‹é‡å¤å¸§ï¼šå¦‚æœå¸§IDä¸ä¸Šä¸€å¸§ç›¸åŒï¼Œè¯´æ˜æ˜¯é‡å¤å‘é€ï¼Œä¸è®¡æ•°
            if (frameId !== undefined && frameId === stats.lastFrameId) {
                stats.duplicateFrames++;
                console.log(`[é‡å¤å¸§] å¸§ID: ${frameId} - å·²è·³è¿‡è®¡æ•° (ç´¯è®¡é‡å¤: ${stats.duplicateFrames})`);
                return;  // è·³è¿‡é‡å¤å¸§
            }

            // æ£€æµ‹ä¸¢å¸§ï¼šå¦‚æœå¸§IDä¸è¿ç»­ï¼Œè¯´æ˜æœ‰å¸§è¢«è·³è¿‡
            if (stats.lastFrameId !== -1 && frameId !== undefined) {
                const expectedFrameId = stats.lastFrameId + 1;
                if (frameId > expectedFrameId) {
                    const dropped = frameId - expectedFrameId;
                    stats.droppedFrames += dropped;
                    console.log(`[ä¸¢å¸§è­¦å‘Š] æœŸæœ›å¸§ID: ${expectedFrameId}, å®é™…: ${frameId}, ä¸¢å¤±: ${dropped}å¸§ (ç´¯è®¡ä¸¢å¤±: ${stats.droppedFrames})`);
                }
            }

            const currentTime = Date.now();
            stats.framesSinceLastUpdate++;
            stats.lastFrameId = frameId;  // æ›´æ–°ä¸Šä¸€å¸§ID

            if (currentTime - stats.lastFPSUpdate >= 1000) {
                const clientFPS = stats.framesSinceLastUpdate;

                // æ˜¾ç¤ºå®¢æˆ·ç«¯å®é™…æ¥æ”¶çš„å”¯ä¸€å¸§ç‡ï¼Œå¹¶é™„åŠ ä¸¢å¸§ä¿¡æ¯
                let fpsText = `å®¢æˆ·ç«¯: ${clientFPS} FPS`;
                if (stats.droppedFrames > 0) {
                    fpsText += ` (ä¸¢${stats.droppedFrames})`;
                }

                elements.leftFPS.textContent = fpsText;
                elements.rightFPS.textContent = fpsText;

                console.log(`[FPS Update] å®¢æˆ·ç«¯å”¯ä¸€å¸§ç‡: ${clientFPS} FPS | é‡å¤å¸§: ${stats.duplicateFrames} | ä¸¢å¸§: ${stats.droppedFrames}`);

                stats.framesSinceLastUpdate = 0;
                stats.lastFPSUpdate = currentTime;
            }
        }

        // éšè—å›¾åƒå¸§
        function hideFrames() {
            elements.leftIRFrame.style.display = 'none';
            elements.rightIRFrame.style.display = 'none';
            elements.leftPlaceholder.style.display = 'flex';
            elements.rightPlaceholder.style.display = 'flex';
            
            elements.leftPlaceholder.textContent = 'ç­‰å¾…å·¦ç›¸æœºæ•°æ®...';
            elements.rightPlaceholder.textContent = 'ç­‰å¾…å³ç›¸æœºæ•°æ®...';
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            const statusElement = elements.connectionStatus;
            const statusValue = elements.statusValue;
            
            switch (status) {
                case 'connected':
                    statusElement.textContent = 'å·²è¿æ¥';
                    statusElement.className = 'connection-status status-connected';
                    statusValue.textContent = 'åœ¨çº¿';
                    statusValue.style.color = '#28a745';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'æ–­å¼€è¿æ¥';
                    statusElement.className = 'connection-status status-disconnected';
                    statusValue.textContent = 'ç¦»çº¿';
                    statusValue.style.color = '#dc3545';
                    break;
                case 'connecting':
                    statusElement.textContent = 'è¿æ¥ä¸­...';
                    statusElement.className = 'connection-status status-connecting';
                    statusValue.textContent = 'è¿æ¥ä¸­';
                    statusValue.style.color = '#ffc107';
                    break;
            }
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            elements.connectBtn.disabled = isConnected;
            elements.disconnectBtn.disabled = !isConnected;
            elements.saveBtn.disabled = !isConnected;
        }

        // å°è¯•é‡è¿
        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.pow(2, reconnectAttempts) * 1000; // æŒ‡æ•°é€€é¿
                
                addLog(`ğŸ”„ ${delay/1000}ç§’åå°è¯•é‡è¿ (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
                
                setTimeout(() => {
                    if (!isConnected) {
                        connectWebSocket();
                    }
                }, delay);
            } else {
                addLog('âŒ è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œè¯·æ‰‹åŠ¨é‡è¿', 'error');
            }
        }

        // ä¿å­˜å½“å‰å¸§
        function saveCurrentFrames() {
            if (!isConnected) return;
            
            const leftFrame = elements.leftIRFrame;
            const rightFrame = elements.rightIRFrame;
            
            if (leftFrame.src && rightFrame.src) {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                
                // ä¸‹è½½å·¦å›¾åƒ
                downloadImage(leftFrame.src, `left_infrared_${timestamp}.jpg`);
                
                // ä¸‹è½½å³å›¾åƒ
                downloadImage(rightFrame.src, `right_infrared_${timestamp}.jpg`);
                
                addLog(`ğŸ’¾ å·²ä¿å­˜å›¾åƒ: ${timestamp}`, 'success');
            } else {
                addLog('âŒ æ²¡æœ‰å¯ä¿å­˜çš„å›¾åƒ', 'warning');
            }
        }

        // ä¸‹è½½å›¾åƒ
        function downloadImage(dataURL, filename) {
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // æ›´æ–°å›¾åƒè´¨é‡
        function updateQuality() {
            const quality = elements.qualitySlider.value;
            elements.qualityValue.textContent = `${quality}%`;
            
            // è¿™é‡Œå¯ä»¥å‘é€è´¨é‡è°ƒæ•´å‘½ä»¤åˆ°æœåŠ¡å™¨
            if (websocket && isConnected) {
                const message = {
                    type: 'quality_adjustment',
                    quality: parseInt(quality)
                };
                websocket.send(JSON.stringify(message));
                addLog(`ğŸ¨ å›¾åƒè´¨é‡è°ƒæ•´ä¸º: ${quality}%`, 'info');
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            elements.logsContainer.appendChild(logEntry);
            elements.logsContainer.scrollTop = elements.logsContainer.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ•°é‡
            while (elements.logsContainer.children.length > 100) {
                elements.logsContainer.removeChild(elements.logsContainer.firstChild);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            elements.logsContainer.innerHTML = '';
            addLog('ğŸ“ æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸŒ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿æ¥ä¼ æ„Ÿå™¨', 'info');
            updateButtons();
            
            // è‡ªåŠ¨è¿æ¥ï¼ˆå¯é€‰ï¼‰
            // connectWebSocket();
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
        window.addEventListener('beforeunload', function() {
            if (websocket && isConnected) {
                websocket.close();
            }
        });
    </script>
</body>
</html>
