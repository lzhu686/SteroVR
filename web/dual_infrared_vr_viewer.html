<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰</title>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.178.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.178.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            max-width: 350px;
            backdrop-filter: blur(10px);
        }
        
        #status {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }
        
        .status-connected { color: #4CAF50; font-weight: bold; }
        .status-disconnected { color: #f44336; font-weight: bold; }
        
        #vrButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        /* éVRæ¨¡å¼ä¸‹çš„é¢„è§ˆ */
        #preview-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .preview-eye {
            flex: 1;
            position: relative;
            background: #111;
            border: 2px solid #333;
        }

        .preview-eye canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .eye-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
        }

        /* VRæ¨¡å¼éšè—é¢„è§ˆ */
        body.vr-mode #preview-container {
            display: none;
        }
        
        body.vr-mode #info,
        body.vr-mode #status {
            display: none;
        }
    </style>
</head>
<body>
    <div id="info">
        <h2>ğŸ¥½ åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰</h2>
        <p>USBåŒç›®ç›¸æœº VR ç«‹ä½“æ˜¾ç¤º</p>
        <ul style="font-size: 12px;">
            <li>å·¦ç›® â†’ å·¦çœ¼è§†è§‰</li>
            <li>å³ç›® â†’ å³çœ¼è§†è§‰</li>
            <li>å®æ—¶ç«‹ä½“æ·±åº¦æ„ŸçŸ¥</li>
            <li>WebXR å¤šè®¾å¤‡æ”¯æŒ</li>
            <li>WebSocketå®æ—¶ä¼ è¾“</li>
        </ul>
        <p style="font-size: 11px; color: #aaa; margin-top: 10px;">
            ç‚¹å‡»"è¿›å…¥VR"æŒ‰é’®å¼€å§‹ç«‹ä½“è§†è§‰ä½“éªŒ
        </p>
    </div>
    
    <div id="status">
        <div>ğŸ”Œ WebSocket: <span id="wsStatus" class="status-disconnected">æœªè¿æ¥</span></div>
        <div>ğŸ¥½ VRçŠ¶æ€: <span id="vrStatus">æœªå¯åŠ¨</span></div>
        <div>ğŸ“¡ å›¾åƒæ•°æ®: <span id="irStatus">æœªæ¥æ”¶</span></div>
        <div>ğŸ“Š å¸§ç‡: <span id="dataRate">0 FPS</span></div>
        <div>ğŸ¯ å»¶è¿Ÿ: <span id="latency">0ms</span></div>
    </div>

    <!-- éVRæ¨¡å¼é¢„è§ˆ -->
    <div id="preview-container">
        <div class="preview-eye">
            <div class="eye-label">ğŸ‘ï¸ å·¦çœ¼è§†å›¾ (Left)</div>
            <canvas id="leftEyeCanvas"></canvas>
        </div>
        <div class="preview-eye">
            <div class="eye-label">ğŸ‘ï¸ å³çœ¼è§†å›¾ (Right)</div>
            <canvas id="rightEyeCanvas"></canvas>
        </div>
    </div>
    
    <div id="vrButton"></div>
    
    <script type="module">
        import * as THREE from 'three';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        
        /**
         * åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰æ˜¾ç¤ºå™¨
         * å°†USBåŒç›®ç›¸æœºçš„å·¦å³å›¾åƒåˆ†åˆ«æ˜¾ç¤ºåˆ°VRå¤´æ˜¾çš„å·¦å³çœ¼
         * å®ç°çœŸæ­£çš„ç«‹ä½“æ·±åº¦æ„ŸçŸ¥ä½“éªŒ
         */
        class Quest3StereoIRViewer {
            constructor() {
                // 3Dåœºæ™¯åŸºç¡€è®¾ç½®
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                
                // WebSocketè¿æ¥
                this.websocket = null;
                this.isConnected = false;
                
                // VRçŠ¶æ€
                this.isVRActive = false;
                
                // è°ƒè¯•è®¡æ•°å™¨
                this.debugFrameCount = 0;
                
                // â­ï¸ åŒç›®ç›¸æœºå‚æ•° (125Â° DFOV, 60mmåŸºçº¿)
                this.cameraSpecs = {
                    diagonalFOV: 125,        // å¯¹è§’çº¿è§†åœºè§’ï¼ˆåº¦ï¼‰
                    aspectRatio: 16 / 9,     // å®½é«˜æ¯”
                    baseline: 0.0,           // â­ï¸ è®¾ç½®ä¸º0ï¼Œä½¿å·¦å³çœ¼ç”»é¢åœ¨åŒä¸€ä½ç½®æ˜¾ç¤º(like look 3d movie)
                    imageWidth: 3840,        // å›¾åƒå®½åº¦ (å·²æ›´æ–°ä¸º3840x1080æ¨¡å¼çš„å•çœ¼åˆ†è¾¨ç‡)
                    imageHeight: 1080        // å›¾åƒé«˜åº¦ (å·²æ›´æ–°ä¸º3840x1080æ¨¡å¼çš„å•çœ¼åˆ†è¾¨ç‡)
                };
                
                // è®¡ç®—çš„VRæ˜¾ç¤ºå‚æ•°
                this.vrDisplayParams = this.calculateVRDisplayParams();
                
                // å›¾åƒçº¹ç†å’Œæè´¨
                this.leftIRTexture = null;
                this.rightIRTexture = null;
                this.leftEyeMaterial = null;
                this.rightEyeMaterial = null;
                
                // ç«‹ä½“æ˜¾ç¤ºå¹³é¢
                this.vrLeftPlane = null;
                this.vrRightPlane = null;

                // â­ï¸ 1. å®šä¹‰æ¸²æŸ“å±‚
                this.LEFT_EYE_LAYER = 1;
                this.RIGHT_EYE_LAYER = 2;
                
                // éVRé¢„è§ˆç”»å¸ƒ
                this.leftEyeCanvas = document.getElementById('leftEyeCanvas');
                this.rightEyeCanvas = document.getElementById('rightEyeCanvas');
                this.leftEyeCtx = this.leftEyeCanvas.getContext('2d');
                this.rightEyeCtx = this.rightEyeCanvas.getContext('2d');
                
                // æ•°æ®ç»Ÿè®¡
                this.frameCount = 0;
                this.lastUpdateTime = Date.now();
                this.latencySum = 0;
                this.latencyCount = 0;
                
                // ç¼“å­˜å›¾åƒæ•°æ®
                this.lastLeftIRData = null;
                this.lastRightIRData = null;
                
                // æ—¥å¿—ç³»ç»Ÿ
                this.logBuffer = [];
                this.maxLogEntries = 1000;
                this.setupLogging();
                
                this.init();
            }
            
            /**
             * è®¡ç®—VRæ˜¾ç¤ºå‚æ•° - ä¿®å¤ï¼šä½¿ç”¨é€‚ä¸­çš„å±å¹•å°ºå¯¸é¿å…æ¨¡ç³Š
             */
            calculateVRDisplayParams() {
                const specs = this.cameraSpecs;
                
                // â­ï¸ ä¿®å¤æ–¹æ¡ˆï¼šä¸è¿½æ±‚å®Œå…¨åŒ¹é…125Â°FOVï¼Œè€Œæ˜¯ä½¿ç”¨èˆ’é€‚çš„VRæ˜¾ç¤ºå°ºå¯¸
                // 1. ä½¿ç”¨è¾ƒå°çš„æ˜¾ç¤ºè·ç¦»å’Œåˆç†çš„å±å¹•å°ºå¯¸
                const displayDistance = 1;  // å‡å°‘åˆ°1ç±³
                
                // 2. ä½¿ç”¨é€‚ä¸­çš„å±å¹•å°ºå¯¸ï¼Œç¡®ä¿è‰¯å¥½çš„åƒç´ å¯†åº¦
                const screenWidth = 1.6;    // 1.6ç±³å®½ (é€‚ä¸­å°ºå¯¸)
                const screenHeight = 0.9;   // 0.9ç±³é«˜ (ä¿æŒ16:9æ¯”ä¾‹)
                
                // 3. ä»å±å¹•å°ºå¯¸åæ¨FOV (ç”¨äºè°ƒè¯•æ˜¾ç¤º)
                const vfovRad = 2 * Math.atan(screenHeight / (2 * displayDistance));
                const vfovDeg = vfovRad * 180 / Math.PI;
                
                // 4. åŸºçº¿åç§»è®¾ä¸º0ï¼ˆè®©WebXRå¤„ç†ç«‹ä½“æ•ˆæœï¼‰
                const eyeOffset = 0;  // VRæ¨¡å¼ä¸‹ä¸éœ€è¦æ‰‹åŠ¨åç§»
                
                const params = {
                    vfovDeg,
                    vfovRad,
                    displayDistance,
                    screenWidth,
                    screenHeight,
                    eyeOffset
                };
                
                console.log('ğŸ“ VRæ˜¾ç¤ºå‚æ•°ä¼˜åŒ–å®Œæˆ:', {
                    'effective_vfov': `${vfovDeg.toFixed(1)}Â°`,
                    'screen_size': `${screenWidth}m Ã— ${screenHeight}m`,
                    'display_distance': `${displayDistance}m`,
                    'pixel_density': 'ä¼˜åŒ–ååº”è¯¥æ›´æ¸…æ™°',
                    'eye_offset': `${eyeOffset}mm (æ— åç§»)`
                });
                
                return params;
            }
            
            setupLogging() {
                // åˆ›å»ºæ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ
                const logContainer = document.createElement('div');
                logContainer.id = 'logContainer';
                logContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    width: 400px;
                    height: 200px;
                    background: rgba(0,0,0,0.9);
                    color: #00ff00;
                    font-family: 'Courier New', monospace;
                    font-size: 10px;
                    padding: 10px;
                    border-radius: 5px;
                    overflow-y: auto;
                    z-index: 200;
                    border: 1px solid #333;
                    display: none;
                `;
                document.body.appendChild(logContainer);
                
                // åˆ›å»ºæ—¥å¿—åˆ‡æ¢æŒ‰é’®
                const logToggle = document.createElement('button');
                logToggle.textContent = 'ğŸ“‹ æ—¥å¿—';
                logToggle.style.cssText = `
                    position: fixed;
                    bottom: 230px;
                    left: 20px;
                    padding: 5px 10px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    border: 1px solid #333;
                    border-radius: 3px;
                    cursor: pointer;
                    z-index: 201;
                    font-size: 12px;
                `;
                logToggle.onclick = () => {
                    const container = document.getElementById('logContainer');
                    container.style.display = container.style.display === 'none' ? 'block' : 'none';
                };
                document.body.appendChild(logToggle);
                
                this.log('INFO', 'VRç«‹ä½“è§†è§‰ç³»ç»Ÿæ—¥å¿—ç³»ç»Ÿå·²å¯åŠ¨');
            }
            
            log(level, message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    level,
                    message,
                    data
                };
                
                this.logBuffer.push(logEntry);
                if (this.logBuffer.length > this.maxLogEntries) {
                    this.logBuffer.shift();
                }
                
                // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
                this.updateLogDisplay();
                
                // æ§åˆ¶å°è¾“å‡º
                const consoleMsg = `[${timestamp}] ${level}: ${message}`;
                if (data) {
                    console.log(consoleMsg, data);
                } else {
                    console.log(consoleMsg);
                }
            }
            
            updateLogDisplay() {
                const container = document.getElementById('logContainer');
                if (container) {
                    const logHtml = this.logBuffer.map(entry => {
                        const levelColor = {
                            'ERROR': '#ff4444',
                            'WARN': '#ffaa00',
                            'INFO': '#00ff00',
                            'DEBUG': '#00aaff',
                            'VR': '#ff00ff'
                        }[entry.level] || '#ffffff';
                        
                        return `<div style="color: ${levelColor}; margin-bottom: 2px;">
                            [${entry.timestamp}] ${entry.level}: ${entry.message}
                            ${entry.data ? '<br>&nbsp;&nbsp;â†’ ' + JSON.stringify(entry.data) : ''}
                        </div>`;
                    }).join('');
                    
                    container.innerHTML = logHtml;
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            init() {
                try {
                    this.log('INFO', 'å¼€å§‹åˆå§‹åŒ–VRç«‹ä½“è§†è§‰ç³»ç»Ÿ');
                    this.setup3DScene();
                    this.setupVR();
                    this.setupPreviewCanvases();
                    this.connectWebSocket();
                    this.setupEventHandlers();
                    
                    this.log('INFO', 'åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰åˆå§‹åŒ–å®Œæˆ');
                    this.sendLogToServer('INFO', 'åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    this.log('ERROR', 'åˆå§‹åŒ–å¤±è´¥', error);
                    this.sendLogToServer('ERROR', `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                }
            }
            
            setup3DScene() {
                this.log('INFO', 'å¼€å§‹è®¾ç½®3Dåœºæ™¯ - ä½¿ç”¨125Â°FOVä¼˜åŒ–é…ç½®');
                
                // è®¾ç½®æ¸²æŸ“å™¨
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.outputColorSpace = THREE.SRGBColorSpace;
                document.body.appendChild(this.renderer.domElement);
                
                // è®¾ç½®åœºæ™¯èƒŒæ™¯ä¸ºé»‘è‰²
                this.scene.background = new THREE.Color(0x000000);
                
                // â­ï¸ ä½¿ç”¨è®¡ç®—å‡ºçš„ç²¾ç¡®å±å¹•å°ºå¯¸ï¼ˆæ¶ˆé™¤çª—å£æ•ˆåº”ï¼‰
                const { screenWidth, screenHeight, displayDistance, vfovDeg, eyeOffset } = this.vrDisplayParams;
                
                // åˆ›å»ºåŒ¹é…ç‰©ç†ç›¸æœºFOVçš„æ˜¾ç¤ºå¹³é¢
                const planeGeometry = new THREE.PlaneGeometry(screenWidth, screenHeight);
                
                // ğŸ”§ åˆ›å»ºåˆå§‹çº¹ç†
                const createInitialTexture = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = this.cameraSpecs.imageWidth;
                    canvas.height = this.cameraSpecs.imageHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#4CAF50';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('ç­‰å¾…125Â°FOVå›¾åƒæ•°æ®...', canvas.width/2, canvas.height/2 - 20);
                    ctx.fillText(`åŸºçº¿è·ç¦»: ${this.cameraSpecs.baseline * 1000}mm`, canvas.width/2, canvas.height/2 + 20);
                    
                    return new THREE.CanvasTexture(canvas);
                };
                
                // åˆ›å»ºå·¦å³çœ¼çº¹ç†å’Œæè´¨
                this.leftIRTexture = createInitialTexture();
                this.leftIRTexture.format = THREE.RGBFormat;
                this.leftIRTexture.minFilter = THREE.LinearFilter;
                this.leftIRTexture.magFilter = THREE.LinearFilter;
                this.leftIRTexture.flipY = false;
                
                this.leftEyeMaterial = new THREE.MeshBasicMaterial({ 
                    map: this.leftIRTexture,
                    side: THREE.FrontSide,
                    depthTest: false,
                    transparent: false
                });
                
                this.rightIRTexture = createInitialTexture();
                this.rightIRTexture.format = THREE.RGBFormat;
                this.rightIRTexture.minFilter = THREE.LinearFilter;
                this.rightIRTexture.magFilter = THREE.LinearFilter;
                this.rightIRTexture.flipY = false;
                
                this.rightEyeMaterial = new THREE.MeshBasicMaterial({ 
                    map: this.rightIRTexture,
                    side: THREE.FrontSide,
                    depthTest: false,
                    transparent: false
                });
                
                // â­ï¸ VRæ¨¡å¼ï¼šæ¯åªçœ¼ç›éƒ½çœ‹åˆ°æ­£å‰æ–¹çš„å¹³é¢ï¼ˆWebXRä¼šè‡ªåŠ¨å¤„ç†ç«‹ä½“æ•ˆæœï¼‰
                // å…³é”®ï¼šä¸è¦åœ¨ç©ºé—´ä¸­åç§»å¹³é¢ï¼Œè€Œæ˜¯è®©WebXRçš„å·¦å³çœ¼ç›¸æœºå„è‡ªæ¸²æŸ“å¯¹åº”çš„å±‚
                this.vrLeftPlane = new THREE.Mesh(planeGeometry, this.leftEyeMaterial);
                this.vrLeftPlane.position.set(0, 0, -displayDistance); // æ­£å‰æ–¹
                this.vrLeftPlane.layers.set(this.LEFT_EYE_LAYER);
                this.vrLeftPlane.visible = false;
                this.scene.add(this.vrLeftPlane);
                
                this.vrRightPlane = new THREE.Mesh(planeGeometry.clone(), this.rightEyeMaterial);
                this.vrRightPlane.position.set(0, 0, -displayDistance); // æ­£å‰æ–¹
                this.vrRightPlane.layers.set(this.RIGHT_EYE_LAYER);
                this.vrRightPlane.visible = false;
                this.scene.add(this.vrRightPlane);
                
                // é¢„è§ˆæ¨¡å¼ï¼šåˆ›å»ºä¸¤ä¸ªé‡å å¹³é¢ï¼ˆç”¨äºæµ‹è¯•æ ¡æ­£æ•ˆæœï¼‰
                const previewGeometry = new THREE.PlaneGeometry(2.4, 1.8); // ç¨å°çš„é¢„è§ˆå°ºå¯¸
                this.previewLeftPlane = new THREE.Mesh(previewGeometry, this.leftEyeMaterial);
                this.previewRightPlane = new THREE.Mesh(previewGeometry, this.rightEyeMaterial);
                
                // â­ï¸ è®¾ç½®ä¸ºç›¸åŒä½ç½®ï¼Œç”¨äºè§‚å¯Ÿæ ¡æ­£æ•ˆæœï¼ˆæ— åç§»æµ‹è¯•ï¼‰
                this.previewLeftPlane.position.set(0, 0, -2.5);  // å±…ä¸­æ˜¾ç¤º
                this.previewRightPlane.position.set(0, 0, -2.4); // ç¨å¾®å‰ç§»ï¼Œé¿å…Z-fighting
                
                this.scene.add(this.previewLeftPlane);
                this.scene.add(this.previewRightPlane);
                
                // â­ï¸ æ›´æ–°ä¸»ç›¸æœºFOVä»¥åŒ¹é…ç‰©ç†ç›¸æœº
                this.camera.fov = vfovDeg;
                this.camera.position.set(0, 0, 0);
                this.camera.updateProjectionMatrix();
                
                // æ·»åŠ å…‰ç…§
                const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
                this.scene.add(ambientLight);
                
                this.log('INFO', `3Dåœºæ™¯è®¾ç½®å®Œæˆ - FOV:${vfovDeg.toFixed(1)}Â°, å±å¹•:${screenWidth.toFixed(2)}Ã—${screenHeight.toFixed(2)}m, åŸºçº¿åç§»:Â±${(eyeOffset*1000).toFixed(1)}mm`);
            }
            
            setupVR() {
                this.log('INFO', 'å¼€å§‹è®¾ç½®WebXR VRç¯å¢ƒ');
                
                // å¯ç”¨WebXR
                this.renderer.xr.enabled = true;
                this.log('DEBUG', 'WebXRå·²åœ¨æ¸²æŸ“å™¨ä¸­å¯ç”¨');
                
                // æ£€æŸ¥WebXRæ”¯æŒ
                if ('xr' in navigator) {
                    this.log('INFO', 'æµè§ˆå™¨æ”¯æŒWebXR');
                    navigator.xr.isSessionSupported('immersive-vr').then(supported => {
                        this.log('INFO', `immersive-vrä¼šè¯æ”¯æŒ: ${supported}`);
                    });
                } else {
                    this.log('WARN', 'æµè§ˆå™¨ä¸æ”¯æŒWebXR');
                }
                
                // åˆ›å»ºVRæŒ‰é’® - ä½¿ç”¨æ ‡å‡†WebXRåŠŸèƒ½
                const vrButton = VRButton.createButton(this.renderer);
                vrButton.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    right: 20px;
                    padding: 15px 25px;
                    font-size: 16px;
                    font-weight: bold;
                    background: linear-gradient(45deg, #4CAF50, #45a049);
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    z-index: 1000;
                    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
                    transition: all 0.3s ease;
                `;
                vrButton.addEventListener('mouseenter', () => {
                    vrButton.style.transform = 'translateY(-2px)';
                    vrButton.style.boxShadow = '0 6px 20px rgba(76, 175, 80, 0.4)';
                });
                vrButton.addEventListener('mouseleave', () => {
                    vrButton.style.transform = 'translateY(0)';
                    vrButton.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
                });
                document.getElementById('vrButton').appendChild(vrButton);
                
                // VRä¼šè¯äº‹ä»¶
                this.renderer.xr.addEventListener('sessionstart', () => this.onVRStart());
                this.renderer.xr.addEventListener('sessionend', () => this.onVREnd());
                
                // å¯åŠ¨æ¸²æŸ“å¾ªç¯ - ä½¿ç”¨WebXRå…¼å®¹çš„æ–¹æ³•
                this.renderer.setAnimationLoop((time, frame) => {
                    // WebXRä¼šè‡ªåŠ¨ä¸ºæ¯åªçœ¼ç›è°ƒç”¨è¿™ä¸ªå‡½æ•°
                    // frameå‚æ•°åŒ…å«æ¯åªçœ¼ç›çš„è§†å›¾ä¿¡æ¯
                    this.render(time, frame);
                });
                
                // è®¾ç½®WebXRå‚è€ƒç©ºé—´ç±»å‹
                this.renderer.xr.setReferenceSpaceType('local');
                
                this.log('INFO', 'WebXRå…¼å®¹çš„æ¸²æŸ“å¾ªç¯å·²å¯åŠ¨');
            }
            
            setupPreviewCanvases() {
                // è®¾ç½®é¢„è§ˆç”»å¸ƒå¤§å°
                const updateCanvasSize = () => {
                    const container = document.getElementById('preview-container');
                    const rect = container.getBoundingClientRect();
                    
                    this.leftEyeCanvas.width = rect.width / 2;
                    this.leftEyeCanvas.height = rect.height;
                    this.rightEyeCanvas.width = rect.width / 2;
                    this.rightEyeCanvas.height = rect.height;
                };
                
                updateCanvasSize();
                window.addEventListener('resize', updateCanvasSize);
            }
            
            connectWebSocket() {
                try {
                    const WS_HOST = window.location.hostname || 'localhost';
                    const WS_PORT = 8765;
                    
                    // ä½¿ç”¨å®‰å…¨çš„WebSocketè¿æ¥ (wss://) å½“é¡µé¢é€šè¿‡HTTPSåŠ è½½æ—¶
                    const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const WS_URL = `${WS_PROTOCOL}//${WS_HOST}:${WS_PORT}`;
                    
                    console.log(`å°è¯•è¿æ¥åˆ°: ${WS_URL}`);
                    this.updateStatus('wsStatus', 'è¿æ¥ä¸­...', 'status-connecting');
                    
                    this.websocket = new WebSocket(WS_URL);
                    
                    this.websocket.onopen = () => {
                        console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                        this.isConnected = true;
                        this.updateStatus('wsStatus', 'å·²è¿æ¥', 'status-connected');
                        this.sendLogToServer('INFO', 'WebSocketè¿æ¥å·²å»ºç«‹');
                    };
                    
                    this.websocket.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleWebSocketMessage(data);
                        } catch (error) {
                            console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                        }
                    };
                    
                    this.websocket.onclose = () => {
                        console.log('WebSocketè¿æ¥å…³é—­');
                        this.isConnected = false;
                        this.updateStatus('wsStatus', 'æœªè¿æ¥', 'status-disconnected');
                        this.updateStatus('irStatus', 'æœªæ¥æ”¶', 'status-disconnected');
                        this.sendLogToServer('WARN', 'WebSocketè¿æ¥å·²æ–­å¼€');
                        
                        // å°è¯•é‡è¿
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };
                    
                    this.websocket.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        this.updateStatus('wsStatus', 'é”™è¯¯', 'status-disconnected');
                    };
                    
                } catch (error) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                    this.updateStatus('wsStatus', 'è¿æ¥å¤±è´¥', 'status-disconnected');
                }
            }
            
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'connection_established':
                        console.log('ä¼ æ„Ÿå™¨è¿æ¥å·²å»ºç«‹:', data.camera_info);
                        this.sendLogToServer('INFO', `ä¼ æ„Ÿå™¨è¿æ¥: ${data.camera_info.width}x${data.camera_info.height}@${data.camera_info.fps}fps`);
                        break;
                        
                    case 'dual_infrared_frame':
                        this.handleInfraredFrame(data);
                        break;
                        
                    default:
                        console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
                }
            }
            
            handleInfraredFrame(data) {
                const { left_infrared, right_infrared, timestamp, metadata } = data;

                if (!left_infrared || !right_infrared) {
                    console.warn('âŒ ç¼ºå°‘å›¾åƒæ•°æ®');
                    return;
                }

                // 1. æ›´æ–°é¢„è§ˆç”»å¸ƒï¼ˆéVRæ¨¡å¼ä¸‹è§‚çœ‹ï¼‰
                this.updatePreviewCanvas(this.leftEyeCtx, left_infrared);
                this.updatePreviewCanvas(this.rightEyeCtx, right_infrared);

                // 2. â­ï¸ å¦‚æœVRæ¿€æ´»ï¼Œæ›´æ–°Layer Canvaså’ŒTHREE.jsçº¹ç†
                if (this.isVRActive && this.leftLayerCtx && this.rightLayerCtx) {
                    this.updateLayerCanvas(this.leftLayerCtx, left_infrared);
                    this.updateLayerCanvas(this.rightLayerCtx, right_infrared);
                    
                    // æ›´æ–°THREE.jsçº¹ç†
                    if (this.leftIRTexture && this.rightIRTexture) {
                        this.leftIRTexture.needsUpdate = true;
                        this.rightIRTexture.needsUpdate = true;
                    }
                }

                // æ›´æ–°ç»Ÿè®¡
                this.frameCount++;
                const currentTime = Date.now();
                const latency = currentTime - (timestamp * 1000);
                this.latencySum += latency;
                this.latencyCount++;
                this.updateDataRate();
                this.updateLatencyDisplay();
                this.updateStatus('irStatus', 'å®æ—¶æ¥æ”¶', 'status-connected');
            }

            // ä¸“é—¨ç”¨äºæ›´æ–°Canvasçš„è¾…åŠ©å‡½æ•°ï¼Œé¿å…ä»£ç é‡å¤
            updateLayerCanvas(ctx, base64Data) {
                if (!ctx.image) {
                    ctx.image = new Image();
                }
                ctx.image.onload = () => {
                    ctx.drawImage(ctx.image, 0, 0, ctx.canvas.width, ctx.canvas.height);
                };
                ctx.image.onerror = (e) => {
                    console.error("å›¾åƒåŠ è½½åˆ°å±‚ç”»å¸ƒå¤±è´¥:", e);
                };
                ctx.image.src = `data:image/jpeg;base64,${base64Data}`;
            }

            // æ›´æ–°é¢„è§ˆç”»å¸ƒçš„è¾…åŠ©å‡½æ•°
            updatePreviewCanvas(ctx, base64Data) {
                if (!ctx.previewImage) {
                    ctx.previewImage = new Image();
                }
                ctx.previewImage.onload = () => {
                    ctx.drawImage(ctx.previewImage, 0, 0, ctx.canvas.width, ctx.canvas.height);
                };
                ctx.previewImage.onerror = (e) => {
                    console.error("å›¾åƒåŠ è½½åˆ°é¢„è§ˆç”»å¸ƒå¤±è´¥:", e);
                };
                ctx.previewImage.src = `data:image/jpeg;base64,${base64Data}`;
            }


            async onVRStart() {
                this.log('VR', 'VRä¼šè¯å¼€å§‹ - å¯ç”¨ç«‹ä½“è§†è§‰æ¸²æŸ“');
                this.isVRActive = true;
                document.body.classList.add('vr-mode');
                this.updateStatus('vrStatus', 'VRæ´»åŠ¨', 'status-connected');

                // éšè—3Dåœºæ™¯ä¸­çš„é¢„è§ˆå¹³é¢
                this.previewLeftPlane.visible = false;
                this.previewRightPlane.visible = false;

                try {
                    this.log('VR', 'å¯ç”¨WebXRæ­£ç¡®çš„ç«‹ä½“å±‚æ¸²æŸ“');
                    
                    // â­ï¸ å…³é”®ä¿®å¤ï¼šç›´æ¥æ§åˆ¶WebXRç›¸æœºçš„å±‚è®¾ç½®
                    const xrCamera = this.renderer.xr.getCamera();
                    
                    // è®¾ç½®å·¦çœ¼ç›¸æœºåªçœ‹å·¦çœ¼å±‚ (layer 1)
                    // è®¾ç½®å³çœ¼ç›¸æœºåªçœ‹å³çœ¼å±‚ (layer 2)  
                    this.renderer.xr.addEventListener('sessionstart', () => {
                        // åœ¨æ¯å¸§æ¸²æŸ“å‰è®¾ç½®ç›¸æœºå±‚
                        const originalRender = this.renderer.render;
                        this.renderer.render = (scene, camera) => {
                            if (this.renderer.xr.isPresenting) {
                                const xrCamera = this.renderer.xr.getCamera();
                                if (xrCamera.cameras && xrCamera.cameras.length >= 2) {
                                    // â­ï¸ å¼ºåˆ¶è®¾ç½®æ¯ä¸ªçœ¼ç›çš„ç›¸æœºå±‚
                                    xrCamera.cameras[0].layers.disableAll();
                                    xrCamera.cameras[0].layers.enable(this.LEFT_EYE_LAYER);  // å·¦çœ¼åªçœ‹å±‚1
                                    
                                    xrCamera.cameras[1].layers.disableAll(); 
                                    xrCamera.cameras[1].layers.enable(this.RIGHT_EYE_LAYER); // å³çœ¼åªçœ‹å±‚2
                                    
                                    this.log('DEBUG', `ç›¸æœºå±‚è®¾ç½®: å·¦çœ¼=${this.LEFT_EYE_LAYER}, å³çœ¼=${this.RIGHT_EYE_LAYER}`);
                                }
                            }
                            originalRender.call(this.renderer, scene, camera);
                        };
                    });

                    // æ˜¾ç¤ºVRå¹³é¢å¹¶ç¡®ä¿å±‚è®¾ç½®
                    this.vrLeftPlane.visible = true;
                    this.vrRightPlane.visible = true;
                    
                    // â­ï¸ å¼ºåˆ¶é‡æ–°è®¾ç½®å±‚å½’å±
                    this.vrLeftPlane.layers.disableAll();
                    this.vrLeftPlane.layers.enable(this.LEFT_EYE_LAYER);
                    
                    this.vrRightPlane.layers.disableAll();
                    this.vrRightPlane.layers.enable(this.RIGHT_EYE_LAYER);

                    // â­ï¸ åˆ›å»ºCanvasä½œä¸ºçº¹ç†æº - ä½¿ç”¨å®é™…è§†é¢‘æµåˆ†è¾¨ç‡
                    const leftLayerCanvas = document.createElement('canvas');
                    leftLayerCanvas.width = this.cameraSpecs.imageWidth;   // 1280
                    leftLayerCanvas.height = this.cameraSpecs.imageHeight; // 720
                    this.leftLayerCtx = leftLayerCanvas.getContext('2d');
                    this.leftLayerCtx.fillStyle = '#003300'; // æ·±ç»¿è‰²èƒŒæ™¯åŒºåˆ†å·¦çœ¼
                    this.leftLayerCtx.fillRect(0, 0, leftLayerCanvas.width, leftLayerCanvas.height);
                    this.leftLayerCtx.fillStyle = '#00FF00';
                    this.leftLayerCtx.font = 'bold 48px Arial';  // å¢å¤§å­—ä½“é€‚åº”æ›´é«˜åˆ†è¾¨ç‡
                    this.leftLayerCtx.textAlign = 'center';
                    this.leftLayerCtx.fillText('LEFT EYE', leftLayerCanvas.width/2, leftLayerCanvas.height/2 - 60);
                    this.leftLayerCtx.fillText('1280x720 IR', leftLayerCanvas.width/2, leftLayerCanvas.height/2);
                    this.leftLayerCtx.fillText('Layer: ' + this.LEFT_EYE_LAYER, leftLayerCanvas.width/2, leftLayerCanvas.height/2 + 60);

                    const rightLayerCanvas = document.createElement('canvas');
                    rightLayerCanvas.width = this.cameraSpecs.imageWidth;   // 1280
                    rightLayerCanvas.height = this.cameraSpecs.imageHeight; // 720
                    this.rightLayerCtx = rightLayerCanvas.getContext('2d');
                    this.rightLayerCtx.fillStyle = '#000033'; // æ·±è“è‰²èƒŒæ™¯åŒºåˆ†å³çœ¼
                    this.rightLayerCtx.fillRect(0, 0, rightLayerCanvas.width, rightLayerCanvas.height);
                    this.rightLayerCtx.fillStyle = '#0088FF';
                    this.rightLayerCtx.font = 'bold 48px Arial';  // å¢å¤§å­—ä½“é€‚åº”æ›´é«˜åˆ†è¾¨ç‡
                    this.rightLayerCtx.textAlign = 'center';
                    this.rightLayerCtx.fillText('RIGHT EYE', rightLayerCanvas.width/2, rightLayerCanvas.height/2 - 60);
                    this.rightLayerCtx.fillText('1280x720 IR', rightLayerCanvas.width/2, rightLayerCanvas.height/2);
                    this.rightLayerCtx.fillText('Layer: ' + this.RIGHT_EYE_LAYER, rightLayerCanvas.width/2, rightLayerCanvas.height/2 + 60);

                    // â­ï¸ æ›´æ–°THREE.jsçº¹ç†
                    this.leftIRTexture = new THREE.CanvasTexture(leftLayerCanvas);
                    this.leftIRTexture.needsUpdate = true;
                    this.leftEyeMaterial.map = this.leftIRTexture;
                    this.leftEyeMaterial.needsUpdate = true;

                    this.rightIRTexture = new THREE.CanvasTexture(rightLayerCanvas);
                    this.rightIRTexture.needsUpdate = true;
                    this.rightEyeMaterial.map = this.rightIRTexture;
                    this.rightEyeMaterial.needsUpdate = true;

                    // ä¿å­˜Canvaså¼•ç”¨
                    this.leftLayerCanvas = leftLayerCanvas;
                    this.rightLayerCanvas = rightLayerCanvas;

                    this.log('VR', `ç«‹ä½“å±‚æ¸²æŸ“å·²æ¿€æ´» - å·¦çœ¼å±‚:${this.LEFT_EYE_LAYER}, å³çœ¼å±‚:${this.RIGHT_EYE_LAYER}`);
                    this.sendLogToServer('INFO', 'VRä¼šè¯å·²å¯åŠ¨ï¼Œä½¿ç”¨æ­£ç¡®çš„ç«‹ä½“å±‚æ¸²æŸ“');

                } catch (error) {
                    this.log('ERROR', 'VRåˆå§‹åŒ–å¤±è´¥', error);
                    this.sendLogToServer('ERROR', `VRåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    
                    // é™çº§åˆ°åŸºç¡€æ˜¾ç¤ºæ¨¡å¼
                    this.vrLeftPlane.visible = true;
                    this.vrRightPlane.visible = true;
                }
            }
            
            onVREnd() {
                this.log('VR', 'VRä¼šè¯ç»“æŸ');
                this.isVRActive = false;
                document.body.classList.remove('vr-mode');
                this.updateStatus('vrStatus', 'æœªå¯åŠ¨', 'status-disconnected');

                // â­ï¸ æ¸…ç†VRç›¸å…³èµ„æº
                this.leftLayerCtx = null;
                this.rightLayerCtx = null;
                this.leftLayerCanvas = null;
                this.rightLayerCanvas = null;
                this.debugFrameCount = 0;

                // éšè—VRå¹³é¢
                this.vrLeftPlane.visible = false;
                this.vrRightPlane.visible = false;

                // æ¢å¤é¢„è§ˆæ¨¡å¼æ˜¾ç¤º
                this.previewLeftPlane.visible = true;
                this.previewRightPlane.visible = true;

                // é‡ç½®ç›¸æœºå±‚
                this.camera.layers.enableAll();

                this.log('DEBUG', 'å·²æ¢å¤åˆ°é¢„è§ˆæ¨¡å¼');
                this.sendLogToServer('INFO', 'VRä¼šè¯å·²ç»“æŸï¼Œå›åˆ°é¢„è§ˆæ¨¡å¼');
            }
            
            render(time, frame) {
                // â­ï¸ åœ¨VRæ¨¡å¼ä¸‹ï¼Œå¼ºåˆ¶è®¾ç½®ç›¸æœºå±‚åˆ†ç¦»
                if (this.isVRActive && this.renderer.xr.isPresenting) {
                    const xrCamera = this.renderer.xr.getCamera();
                    if (xrCamera.cameras && xrCamera.cameras.length >= 2) {
                        // å·¦çœ¼ç›¸æœº (index 0) åªçœ‹å·¦çœ¼å±‚
                        xrCamera.cameras[0].layers.disableAll();
                        xrCamera.cameras[0].layers.enable(this.LEFT_EYE_LAYER);
                        
                        // å³çœ¼ç›¸æœº (index 1) åªçœ‹å³çœ¼å±‚
                        xrCamera.cameras[1].layers.disableAll();
                        xrCamera.cameras[1].layers.enable(this.RIGHT_EYE_LAYER);
                        
                        // ç¡®ä¿VRå¹³é¢åœ¨æ­£ç¡®çš„å±‚
                        this.vrLeftPlane.layers.disableAll();
                        this.vrLeftPlane.layers.enable(this.LEFT_EYE_LAYER);
                        
                        this.vrRightPlane.layers.disableAll();
                        this.vrRightPlane.layers.enable(this.RIGHT_EYE_LAYER);
                        
                        // è°ƒè¯•æ—¥å¿— (æ¯60å¸§è¾“å‡ºä¸€æ¬¡)
                        this.debugFrameCount++;
                        if (this.debugFrameCount % 60 === 0) {
                            this.log('DEBUG', `å¸§${this.debugFrameCount}: å·¦çœ¼å±‚=${this.LEFT_EYE_LAYER}, å³çœ¼å±‚=${this.RIGHT_EYE_LAYER}`);
                            this.log('DEBUG', `å·¦å¹³é¢å¯è§=${this.vrLeftPlane.visible}, å³å¹³é¢å¯è§=${this.vrRightPlane.visible}`);
                        }
                    }
                    
                    // æ›´æ–°çº¹ç†
                    if (this.leftIRTexture && this.rightIRTexture) {
                        this.leftIRTexture.needsUpdate = true;
                        this.rightIRTexture.needsUpdate = true;
                    }
                }

                // æ¸²æŸ“ä¸‰ç»´åœºæ™¯
                this.renderer.render(this.scene, this.camera);
                
                // æ›´æ–°ç»Ÿè®¡
                this.updateDataRate();
            }
            
            updateDataRate() {
                const currentTime = Date.now();
                const elapsed = currentTime - this.lastUpdateTime;
                
                if (elapsed >= 1000) { // æ¯ç§’æ›´æ–°ä¸€æ¬¡
                    const fps = Math.round(this.frameCount * 1000 / elapsed);
                    this.updateStatus('dataRate', `${fps} FPS`, 'status-connected');
                    
                    this.frameCount = 0;
                    this.lastUpdateTime = currentTime;
                }
            }
            
            updateLatencyDisplay() {
                if (this.latencyCount >= 10) { // æ¯10å¸§æ›´æ–°ä¸€æ¬¡å»¶è¿Ÿæ˜¾ç¤º
                    const avgLatency = Math.round(this.latencySum / this.latencyCount);
                    this.updateStatus('latency', `${avgLatency}ms`, 
                        avgLatency < 50 ? 'status-connected' : 'status-disconnected');
                    
                    this.latencySum = 0;
                    this.latencyCount = 0;
                }
            }
            
            updateStatus(elementId, text, className) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                    element.className = className;
                }
            }
            
            setupEventHandlers() {
                // çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (event) => {
                    switch (event.code) {
                        case 'KeyR':
                            // Ré”®é‡è¿WebSocket
                            if (!this.isConnected) {
                                this.connectWebSocket();
                            }
                            break;
                        case 'KeyF':
                            // Fé”®åˆ‡æ¢å…¨å±
                            if (!document.fullscreenElement) {
                                document.documentElement.requestFullscreen();
                            } else {
                                document.exitFullscreen();
                            }
                            break;
                    }
                });
            }
            
            sendLogToServer(level, message) {
                // å¦‚æœæœ‰å…¶ä»–æ—¥å¿—æœåŠ¡å™¨å¯ä»¥å‘é€åˆ°é‚£é‡Œ
                console.log(`[${level}] ${message}`);
                
                // å¯ä»¥æ‰©å±•ä¸ºå‘é€åˆ°WebSocketæœåŠ¡å™¨çš„æ—¥å¿—åŠŸèƒ½
                if (this.websocket && this.isConnected) {
                    try {
                        const logData = {
                            type: 'client_log',
                            level: level,
                            message: message,
                            timestamp: Date.now(),
                            source: 'Quest3StereoIRViewer'
                        };
                        this.websocket.send(JSON.stringify(logData));
                    } catch (error) {
                        console.error('å‘é€æ—¥å¿—å¤±è´¥:', error);
                    }
                }
            }
        }
        
        // å¯åŠ¨åº”ç”¨
        console.log('å¯åŠ¨åŒç›®RGBç›¸æœº VRç«‹ä½“è§†è§‰æ˜¾ç¤ºå™¨');
        try {
            const viewer = new Quest3StereoIRViewer();
            window.vrViewer = viewer; // ä¾¿äºè°ƒè¯•
        } catch (error) {
            console.error('åº”ç”¨å¯åŠ¨å¤±è´¥:', error);
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åˆ°é¡µé¢
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(220, 53, 69, 0.9);
                color: white;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                z-index: 10000;
            `;
            errorDiv.innerHTML = `
                <h3>âŒ åº”ç”¨å¯åŠ¨å¤±è´¥</h3>
                <p>${error.message}</p>
                <p style="font-size: 12px;">è¯·æ£€æŸ¥æ§åˆ¶å°äº†è§£è¯¦ç»†ä¿¡æ¯</p>
            `;
            document.body.appendChild(errorDiv);
        }
    </script>
</body>
</html>
