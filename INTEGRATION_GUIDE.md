# SteroVR â†’ XRoboToolkit Unity Client é›†æˆæŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©ä½ å°† SteroVR çš„ USB åŒç›®ç›¸æœºè§†é¢‘æµé›†æˆåˆ° XRoboToolkit Unity Client ä¸­ï¼Œè®© PICO å¤´æ˜¾å¯ä»¥å®æ—¶æ¥æ”¶å’Œæ˜¾ç¤º PC ç«¯çš„åŒç›®ç›¸æœºç”»é¢ã€‚

## æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PC (è¿è¡Œ SteroVR)                                               â”‚
â”‚                                                                  â”‚
â”‚  USB åŒç›®ç›¸æœº â”€â”€â†’ OpenCV é‡‡é›† â”€â”€â†’ FFmpeg H.264 ç¼–ç  â”€â”€â†’ UDP å‘é€  â”‚
â”‚                                                                  â”‚
â”‚  ç›‘å¬ TCP 63901 ç«¯å£ï¼Œç­‰å¾… PICO å¤´æ˜¾è¿æ¥                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ UDP (RTP H.264)
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PICO å¤´æ˜¾ (XRoboToolkit Unity Client)                           â”‚
â”‚                                                                  â”‚
â”‚  MediaDecoder (Android ç¡¬è§£ç ) â”€â”€â†’ Unity Texture2D â”€â”€â†’ VR æ˜¾ç¤º    â”‚
â”‚                                                                  â”‚
â”‚  é€‰æ‹©è§†é¢‘æº: USB_STEREO                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å‰ç½®è¦æ±‚

### PC ç«¯

1. **Python 3.8+**
2. **FFmpeg** (ç”¨äº H.264 ç¼–ç )
   ```bash
   # Ubuntu/Debian
   sudo apt-get install ffmpeg

   # Windows
   # ä¸‹è½½: https://ffmpeg.org/download.html
   # æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡

   # macOS
   brew install ffmpeg
   ```

3. **Python ä¾èµ–**
   ```bash
   pip install opencv-python numpy
   ```

4. **USB åŒç›®ç›¸æœº**
   - æ”¯æŒ 2560x720 æˆ–æ›´é«˜åˆ†è¾¨ç‡
   - æ”¯æŒ 60fps

### PICO å¤´æ˜¾ç«¯

1. å®‰è£…æœ€æ–°ç‰ˆ XRoboToolkit Unity Client APK
2. ç¡®ä¿ PICO å’Œ PC åœ¨åŒä¸€å±€åŸŸç½‘

---

## ç¬¬ä¸€æ­¥ï¼šPC ç«¯é…ç½®

### 1.1 æ£€æŸ¥ä¾èµ–

```bash
cd SteroVR
python start_xrobo_compat.py --check
```

è¾“å‡ºåº”è¯¥æ˜¾ç¤ºï¼š
```
ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿä¾èµ–...

  [âœ“] FFmpeg
  [âœ“] OpenCV (cv2)

âœ… æ‰€æœ‰ä¾èµ–å·²æ»¡è¶³
```

### 1.2 æ£€æµ‹ç›¸æœº

```bash
python start_xrobo_compat.py --list-cameras
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
ğŸ“· æ£€æµ‹å¯ç”¨ç›¸æœº...

   è®¾å¤‡ 0: 2560x720
```

### 1.3 å¯åŠ¨æœåŠ¡å™¨

```bash
python start_xrobo_compat.py
```

æˆ–æŒ‡å®šç›¸æœºè®¾å¤‡ï¼š
```bash
python start_xrobo_compat.py --device 0
```

è‡ªå®šä¹‰åˆ†è¾¨ç‡ï¼š
```bash
python start_xrobo_compat.py --width 1920 --height 540 --fps 30
```

æˆåŠŸå¯åŠ¨åä¼šæ˜¾ç¤ºï¼š
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“¡ ç½‘ç»œä¿¡æ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   æœ¬æœº IP: 192.168.1.100
   TCP ç«¯å£: 63901 (æ§åˆ¶)
   ç›¸æœºè®¾å¤‡: 0
   åˆ†è¾¨ç‡: 2560x720
   å¸§ç‡: 60 FPS
   ç ç‡: 8 Mbps
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“± PICO å¤´æ˜¾æ“ä½œæ­¥éª¤:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. æ‰“å¼€ XRoboToolkit Unity Client
   2. åœ¨è§†é¢‘æºä¸‹æ‹‰æ¡†é€‰æ‹©: USB_STEREO
   3. è¾“å…¥ PC IP åœ°å€: 192.168.1.100
   4. ç‚¹å‡» Listen æŒ‰é’®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ğŸš€ å¯åŠ¨æœåŠ¡å™¨...
ç­‰å¾… PICO å¤´æ˜¾è¿æ¥...
```

---

## ç¬¬äºŒæ­¥ï¼šUnity ç«¯é…ç½® (æ‰“åŒ… APK)

### 2.1 æ‰“å¼€ Unity é¡¹ç›®

1. ä½¿ç”¨ Unity Hub æ‰“å¼€ `XRoboToolkit-Unity-Client` é¡¹ç›®
2. Unity ç‰ˆæœ¬è¦æ±‚: **2022.3.16f1**

### 2.2 ç¡®è®¤é…ç½®æ–‡ä»¶å·²æ›´æ–°

æ£€æŸ¥ `Assets/StreamingAssets/video_source.yml` æ˜¯å¦åŒ…å« `USB_STEREO` é…ç½®ï¼š

```yaml
# USB Stereo Camera (SteroVR) - Added for integration
- name: "USB_STEREO"
  camera: "USB"
  description: "USB Stereo Camera via SteroVR"
  properties:
    - name: "visibleRatio"
      type: "float"
      value: 0.439464
    - name: "contentRatio"
      type: "float"
      value: 1.777778
    - name: "heightCompressionFactor"
      type: "float"
      value: 1.777778
    - name: "RawImageRectSize"
      type: "string"
      value: "600x168.75"
    - name: "CamWidth"
      type: "int"
      value: 2560
    - name: "CamHeight"
      type: "int"
      value: 720
    - name: "CamFPS"
      type: "int"
      value: 60
    - name: "CamBitrate"
      type: "int"
      value: 8000000
```

### 2.3 æ‰“åŒ… APK

1. **æ‰“å¼€ Build Settings**
   - èœå•: `File` â†’ `Build Settings`
   - æˆ–å¿«æ·é”®: `Ctrl+Shift+B` (Windows) / `Cmd+Shift+B` (macOS)

2. **ç¡®è®¤å¹³å°è®¾ç½®**
   - Platform: `Android`
   - Texture Compression: `ASTC`

3. **ç‚¹å‡» Build æˆ– Build And Run**
   - é€‰æ‹©è¾“å‡ºè·¯å¾„
   - ç­‰å¾…æ‰“åŒ…å®Œæˆ

4. **å®‰è£… APK åˆ° PICO**
   ```bash
   adb install -r XRoboToolkit-PICO-1.1.1.apk
   ```

---

## ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•è¿æ¥

### 3.1 ç¡®ä¿ç½‘ç»œè¿é€š

åœ¨ PICO å¤´æ˜¾æˆ–æ‰‹æœºä¸Š ping PCï¼š
```bash
ping 192.168.1.100
```

### 3.2 åœ¨ PICO ä¸Šæ“ä½œ

1. **æ‰“å¼€ XRoboToolkit Unity Client**

2. **é€‰æ‹©è§†é¢‘æº**
   - æ‰¾åˆ°è§†é¢‘æºä¸‹æ‹‰æ¡†
   - é€‰æ‹© `USB_STEREO`

3. **è¾“å…¥ PC IP**
   - ç‚¹å‡» Listen æŒ‰é’®
   - åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­è¾“å…¥ PC çš„ IP åœ°å€
   - ä¾‹å¦‚: `192.168.1.100`

4. **ç¡®è®¤è¿æ¥**
   - PC ç«¯ä¼šæ˜¾ç¤º: `å®¢æˆ·ç«¯å·²è¿æ¥: ('192.168.1.xxx', xxxxx)`
   - PICO ç«¯ä¼šå¼€å§‹æ˜¾ç¤ºåŒç›®ç›¸æœºç”»é¢

### 3.3 éªŒè¯è§†é¢‘æµ

PC ç«¯åº”è¯¥æ˜¾ç¤ºï¼š
```
æ”¶åˆ°å‘½ä»¤: StartReceivePcCamera
å¼€å§‹è§†é¢‘æµ: 192.168.1.xxx:12345
å‚æ•°: 2560x720 @ 60fps, 8Mbps
è§†é¢‘æµå·²å¯åŠ¨
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸‹æ‹‰æ¡†æ²¡æœ‰ USB_STEREO é€‰é¡¹

**åŸå› **: video_source.yml æœªæ›´æ–°æˆ– APK æœªé‡æ–°æ‰“åŒ…

**è§£å†³**:
1. ç¡®è®¤ `Assets/StreamingAssets/video_source.yml` å·²æ·»åŠ  USB_STEREO é…ç½®
2. é‡æ–°æ‰“åŒ… APK å¹¶å®‰è£…

### Q2: è¿æ¥å¤±è´¥

**åŸå› **: ç½‘ç»œä¸é€šæˆ–ç«¯å£è¢«é˜²ç«å¢™é˜»æ­¢

**è§£å†³**:
1. ç¡®ä¿ PICO å’Œ PC åœ¨åŒä¸€å±€åŸŸç½‘
2. å…³é—­ PC é˜²ç«å¢™æˆ–æ·»åŠ ç«¯å£ä¾‹å¤– (TCP 63901, UDP 12345)
3. å°è¯•ç”¨æ‰‹æœºè¿æ¥æµ‹è¯•

### Q3: ç›¸æœºåˆå§‹åŒ–å¤±è´¥

**åŸå› **: ç›¸æœºè®¾å¤‡ ID ä¸æ­£ç¡®æˆ–ç›¸æœºè¢«å ç”¨

**è§£å†³**:
1. è¿è¡Œ `python start_xrobo_compat.py --list-cameras` æ£€æŸ¥å¯ç”¨ç›¸æœº
2. ä½¿ç”¨ `--device X` æŒ‡å®šæ­£ç¡®çš„è®¾å¤‡ ID
3. å…³é—­å…¶ä»–ä½¿ç”¨ç›¸æœºçš„ç¨‹åº

### Q4: ç”»é¢å¡é¡¿æˆ–å»¶è¿Ÿé«˜

**åŸå› **: ç½‘ç»œå¸¦å®½ä¸è¶³æˆ–ç¼–ç å‚æ•°è¿‡é«˜

**è§£å†³**:
1. é™ä½åˆ†è¾¨ç‡: `--width 1920 --height 540`
2. é™ä½å¸§ç‡: `--fps 30`
3. é™ä½ç ç‡: `--bitrate 4000000`
4. ä½¿ç”¨ 5GHz WiFi

### Q5: FFmpeg æœªæ‰¾åˆ°

**Windows è§£å†³æ–¹æ¡ˆ**:
1. ä¸‹è½½ FFmpeg: https://ffmpeg.org/download.html
2. è§£å‹åˆ° `C:\ffmpeg`
3. æ·»åŠ  `C:\ffmpeg\bin` åˆ°ç³»ç»Ÿ PATH ç¯å¢ƒå˜é‡
4. é‡å¯ç»ˆç«¯

---

## é«˜çº§é…ç½®

### è°ƒæ•´è§†è§‰å‚æ•°

ä¿®æ”¹ `video_source.yml` ä¸­çš„ shader å‚æ•°ï¼š

```yaml
- name: "visibleRatio"
  value: 0.439464      # å¯è§åŒºåŸŸæ¯”ä¾‹ (è°ƒæ•´æ˜¾ç¤ºèŒƒå›´)

- name: "contentRatio"
  value: 1.777778      # å†…å®¹æ¯”ä¾‹ (è°ƒæ•´å®½é«˜æ¯”)

- name: "heightCompressionFactor"
  value: 1.777778      # é«˜åº¦å‹ç¼©å› å­ (16:9)
```

### è°ƒæ•´ç¼–ç å‚æ•°

ä¿®æ”¹ `h264_sender.py` ä¸­çš„ `VideoConfig`:

```python
config = VideoConfig(
    width=2560,           # è§†é¢‘å®½åº¦
    height=720,           # è§†é¢‘é«˜åº¦
    fps=60,               # å¸§ç‡
    bitrate=8000000,      # ç ç‡ (8 Mbps)
    keyframe_interval=30  # å…³é”®å¸§é—´éš”
)
```

---

## æ–‡ä»¶ç»“æ„

```
SteroVR/
â”œâ”€â”€ server.py                  # åŸå§‹ WebSocket æœåŠ¡å™¨ (ä¿ç•™)
â”œâ”€â”€ start.py                   # åŸå§‹å¯åŠ¨è„šæœ¬ (ä¿ç•™)
â”œâ”€â”€ h264_sender.py             # [æ–°å¢] H.264 è§†é¢‘ç¼–ç å‘é€å™¨
â”œâ”€â”€ xrobo_compat_server.py     # [æ–°å¢] XRoboToolkit åè®®å…¼å®¹æœåŠ¡å™¨
â”œâ”€â”€ start_xrobo_compat.py      # [æ–°å¢] ç»Ÿä¸€å¯åŠ¨è„šæœ¬
â””â”€â”€ INTEGRATION_GUIDE.md       # [æ–°å¢] æœ¬é›†æˆæŒ‡å—

XRoboToolkit-Unity-Client/
â””â”€â”€ Assets/
    â””â”€â”€ StreamingAssets/
        â””â”€â”€ video_source.yml   # [ä¿®æ”¹] æ·»åŠ  USB_STEREO é…ç½®
```

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- ä½œè€…: Liang ZHU
- é‚®ç®±: lzhu686@connect.hkust-gz.edu.cn
