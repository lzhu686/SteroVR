<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USB Stereo WebSocket Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, Helvetica, Arial; padding: 18px; background:#f6f8fa; color:#111 }
    h1 { margin: 0 0 8px 0 }
    #controls { margin-bottom: 12px }
    input[type=text] { width: 360px; padding:6px }
    button { padding:6px 10px; margin-left:6px }
    .stereo { display:flex; gap:12px; flex-wrap:wrap }
    .eye { display:flex; flex-direction:column; align-items:center }
    img { max-width:640px; max-height:480px; width:640px; height:360px; object-fit:contain; background:#000; border:1px solid #ccc }
    #log { width:100%; max-width:1280px; height:140px; overflow:auto; background:#111; color:#0f0; padding:8px; margin-top:12px; font-family:monospace; white-space:pre-wrap }
    .meta { margin-left:8px; color:#555 }
  </style>
</head>
<body>
  <h1>USB Stereo WebSocket Viewer</h1>
  <div id="controls">
    <label>WebSocket URL: <input id="wsUrl" type="text" value="ws://localhost:8765" /></label>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" disabled>Disconnect</button>
    <span class="meta">Status: <strong id="status">Disconnected</strong></span>
  </div>

  <div class="stereo">
    <div class="eye">
      <div>Left</div>
      <img id="leftImg" alt="Left eye image" src="" />
    </div>
    <div class="eye">
      <div>Right</div>
      <img id="rightImg" alt="Right eye image" src="" />
    </div>
  </div>

  <pre id="log">Open the file in a browser and click Connect. If the server runs on a remote host, change the WebSocket URL (e.g. ws://172.16.12.56:8765).</pre>

  <script>
  (function(){
    const wsUrlInput = document.getElementById('wsUrl');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const statusLabel = document.getElementById('status');
    const leftImg = document.getElementById('leftImg');
    const rightImg = document.getElementById('rightImg');
    const logEl = document.getElementById('log');

    let ws = null;

    function log(s){
      const t = new Date().toLocaleTimeString();
      logEl.textContent = t + ' ' + s + '\n' + logEl.textContent;
    }

    connectBtn.addEventListener('click', ()=>{
      const url = wsUrlInput.value.trim();
      if(!url){ log('Please enter a WebSocket URL'); return; }
      try{
        ws = new WebSocket(url);
        log('Connecting to ' + url);
        statusLabel.textContent = 'Connecting...';

        ws.onopen = ()=>{ statusLabel.textContent = 'Connected'; connectBtn.disabled = true; disconnectBtn.disabled = false; log('Connected'); };

        ws.onmessage = (ev)=>{
          try{
            // Expect JSON messages with base64 images (left_infrared/right_infrared)
            const msg = JSON.parse(ev.data);
            if(msg.type === 'dual_infrared_frame'){
              if(msg.left_infrared) leftImg.src = 'data:image/jpeg;base64,' + msg.left_infrared;
              if(msg.right_infrared) rightImg.src = 'data:image/jpeg;base64,' + msg.right_infrared;
              // optionally show small stats
              if(msg.stats) log(`frame sent:${msg.stats.frames_sent} fps:${msg.stats.fps_actual} clients:${msg.stats.client_count}`);
            } else if(msg.type === 'connection_established'){
              log('Server: connection established (mode=' + (msg.server_info?.mode || 'n/a') + ')');
            } else {
              log('Received message: ' + JSON.stringify(msg).slice(0,200));
            }
          }catch(e){ log('Failed to parse message: ' + e); }
        };

        ws.onclose = (ev)=>{ statusLabel.textContent = 'Disconnected'; connectBtn.disabled = false; disconnectBtn.disabled = true; log('Connection closed'); };
        ws.onerror = (ev)=>{ log('WebSocket error'); };
      }catch(e){ log('Connection failed: ' + e); }
    });

    disconnectBtn.addEventListener('click', ()=>{ if(ws) ws.close(); });

    // Helpful: allow pressing Enter to connect
    wsUrlInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') connectBtn.click(); });

    // Hint: if you open this file via file:// you can still connect to ws://host:8765
    log('Viewer ready â€” enter a WebSocket URL and click Connect');
  })();
  </script>
</body>
</html>