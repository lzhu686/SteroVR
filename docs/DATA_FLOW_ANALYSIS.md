# StereoVR 数据流完整梳理与设计决策

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              物理层                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   USB 双目相机 (物理设备)                                                    │
│   /dev/video3 ──────────────────────────────────────────────────────────┐    │
│   原始输出: MJPEG (2560x720@60fps)                                        │    │
│   USB 带宽: ~50-100 Mbps (已压缩)                                         │    │
│                                                                            │    │
│   udev 规则: /dev/stereo_camera → /dev/video3 (固定映射)                  │    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ MJPEG (USB)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           进程 1: 主服务器                                   │
│                     start_xrobo_compat.py + h264_sender.py                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                        FFmpeg 双输出进程                             │   │
│   │                                                                      │   │
│   │   输入: /dev/stereo_camera (MJPEG)                                  │   │
│   │     ↓                                                               │   │
│   │   ┌─────────────────────┬─────────────────────┐                     │   │
│   │   │                     │                     │                     │   │
│   │   ↓                     ↓                     ↓                     │   │
│   │   H.264 编码            Raw Video 编码        MJPEG 解码            │   │
│   │   (NVENC GPU)           (无压缩)              (内部)               │   │
│   │   ↓                     ↓                     ↓                     │   │
│   │   TCP → PICO            /dev/video99          (丢弃)               │   │
│   │   (60fps)               (30fps, YUYV422)                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   协议: XRoboToolkit (TCP 13579 + 动态端口)                                 │
│   输出 1: H.264 → PICO 头显 (实时遥操作)                                    │
│   输出 2: Raw Video → v4l2loopback (ROS2 感知)                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Raw Video YUYV422 (内核内存)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        虚拟设备层 (v4l2loopback)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   /dev/video99 (虚拟相机设备)                                               │
│   - 内核缓冲区: 保存最新帧                                                   │
│   - 格式: YUYV422 (每像素 2 bytes)                                          │
│   - 帧大小: 2560×720×2 = 3.7 MB                                             │
│   - 帧率: 30fps                                                             │
│   - 带宽: 3.7×30 = 110 MB/s (内核内存,零拷贝)                               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ V4L2 API 读取
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        进程 2: ROS2 发布器                                   │
│                      ros2_loopback_publisher.py                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                     数据处理流水线                                    │   │
│   │                                                                      │   │
│   │   /dev/video99 → OpenCV (V4L2) → YUYV422 → BGR → 左右分割 → JPEG   │   │
│   │                         ↑              ↑           ↑         ↑       │   │
│   │                         │              │           │         │       │   │
│   │                    V4L2 后端      颜色空间     2560→      ROS2 传输  │   │
│   │                                 转换        1280×2                │   │
│   │                                                                      │   │
│   │   输出:                                                              │   │
│   │   ├─ /stereo/left/compressed (CompressedImage, ~110KB/帧)          │   │
│   │   └─ /stereo/right/compressed (CompressedImage, ~110KB/帧)         │   │
│   │                                                                      │   │
│   │   帧率: 30fps                                                        │   │
│   │   带宽: 110×2 = 220 KB/s (ROS2 DDS 网络)                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ ROS2 DDS (CycloneDDS/FastDDS)
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ROS2 订阅节点 (机器人)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   /stereo/left/compressed  ──→ SLAM / 目标检测 / 深度估计                   │
│   /stereo/right/compressed ──→ (与左眼同步)                                 │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 为什么这样设计？

### 设计决策矩阵

| 决策点 | 选择 | 原因 |
|--------|------|------|
| 相机输入格式 | MJPEG | USB 带宽有限，压缩传输更高效 |
| PICO 输出格式 | H.264 (NVENC) | 低延迟 + 硬件编码 |
| ROS2 输出格式 | Raw Video YUYV422 | 零丢帧 + 帧边界清晰 |
| 进程隔离 | 双进程架构 | 故障隔离 + 独立资源 |
| 降帧率 | 60fps→30fps | ROS2 感知无需高帧率 |

---

### 详细设计决策

#### 1. 为什么相机输入用 MJPEG？

```
USB 带宽限制 (USB 2.0): ~480 Mbps理论, 实际~200-300 Mbps可用

2560×720@60fps 的不同格式带宽需求:
- Raw BGR: 2560×720×3×60 = 331 MB/s  ❌ 超限
- Raw YUYV422: 2560×720×2×60 = 221 MB/s  ⚠️ 紧张
- MJPEG (压缩率~30:1): ~7-10 MB/s  ✅ 轻松
```

**结论**: MJPEG 是 USB 相机最优化格式，压缩率高且无需额外编码开销。

#### 2. 为什么 PICO 用 H.264？

```
需求: 实时遥操作，低延迟 < 50ms

H.264 优势:
- 帧间压缩 (P帧只存差异) → 减少数据量
- NVENC 硬件编码 → <3ms 编码延迟
- GOP=1 (全关键帧) → 无 B 帧延迟，快速seek
- TCP 可靠传输 → 无丢包重传延迟
```

**结论**: H.264 + NVENC 是低延迟遥操作的行业标准方案。

#### 3. 为什么 ROS2 用 Raw Video？

```
MJPEG 的问题 (之前):
┌────────────────────────────────────────────┐
│  FFmpeg → MJPEG → v4l2loopback → OpenCV  │
│       ↓         ↓          ↓           ↓   │
│    压缩     压缩帧    帧边界模糊    损坏帧   │
│                                        ↓   │
│                                  "Corrupt JPEG" │
│                                        ↓   │
│                                   5-10% 丢帧  ❌
└────────────────────────────────────────────┘

Raw Video 的解决方案:
┌────────────────────────────────────────────┐
│  FFmpeg → Raw Video → v4l2loopback → OpenCV │
│       ↓         ↓          ↓           ↓    │
│   解码      固定大小    帧边界清晰    完整帧  │
│                                      ↓      │
│                                    0% 丢帧  ✅
└────────────────────────────────────────────┘

Raw Video 特性:
- 帧大小固定: 2560×720×2 = 3,686,400 bytes
- 无压缩标记，无边界模糊问题
- 每帧完整，零丢失
```

**结论**: Raw Video 用**带宽换可靠性**，对于 ROS2 感知场景完全可接受。

#### 4. 为什么双进程架构？

```
单进程方案 (不推荐):
┌──────────────────────────────────────────────────┐
│  主进程: PICO 视频流 + ROS2 发布                  │
│                                                  │
│  问题:                                            │
│  - ROS2 崩溃 → PICO 视频流中断                    │
│  - CPU 争抢 → 帧率不稳定                          │
│  - 日志混杂 → 调试困难                            │
│  - 必须同时启动，无法独立运行                      │
└──────────────────────────────────────────────────┘

双进程方案 (推荐):
┌────────────────────┐  ┌────────────────────────────┐
│  进程 1 (PICO)     │  │  进程 2 (ROS2)            │
│  - 60fps 高优先级   │  │  - 30fps 低优先级         │
│  - TCP 实时传输     │  │  - DDS 网络发布           │
│  - 低延迟优先       │  │  - 可靠性优先             │
└─────────┬──────────┘  └────────────┬─────────────┘
          │                         │
          └────────── OR ───────────┘
              (独立运行，互不影响)

优势:
✅ ROS2 崩溃不影响 PICO 实时视频
✅ 独立 CPU/GPU 资源分配
✅ 可独立启动/停止
✅ 日志分离，调试方便
```

#### 5. 为什么降帧率到 30fps？

```
相机采集: 60fps (16.67ms/帧)

ROS2 感知需求:
- SLAM: 15-30fps 足够
- 目标检测: 20-30fps 足够
- 人类视觉: 30fps 是感知阈值

降帧率收益:
- CPU: 减半 (处理帧数减少 50%)
- 网络: 减半 (DDS 带宽减少 50%)
- 存储: 减半 (录制文件大小减少 50%)

对遥操作的影响: 无
- PICO 保持 60fps 实时显示
- ROS2 感知无需更高帧率
```

---

## 数据流详细时序

### 进程 1 (主服务器) 时序

```
时间轴 (ms):
0    │  相机采集 (MJPEG)
16.67│  ├─ H.264 编码 (GPU) ──────────→ TCP → PICO (60fps)
     │  └─ Raw Video (每2帧输出1帧) ────────────────→ /dev/video99 (30fps)
33.33│  相机采集 (MJPEG)
     │  ├─ H.264 编码 (GPU) ──────────→ TCP → PICO
     │  └─ (丢弃) ──────────────────────────────────→
50   │  相机采集 (MJPEG)
     │  ├─ H.264 编码 (GPU) ──────────→ TCP → PICO
     │  └─ Raw Video ──────────────────────────────→ /dev/video99
...
```

### 进程 2 (ROS2 发布) 时序

```
时间轴 (ms):
0    │  OpenCV 读取 /dev/video99
     │  ├─ YUYV422 → BGR 颜色转换 (CPU)
     │  ├─ 左右分割 (1280×720 × 2)
     │  ├─ JPEG 压缩 (CPU)
     │  └─ ROS2 发布 ─────────────────────────────→ DDS (30fps)
33.33│  OpenCV 读取 /dev/video99
     │  └─ 同上
66.67│  OpenCV 读取 /dev/video99
     │  └─ 同上
...
```

---

## 带宽详细计算

### 上游 (USB 相机 → 主服务器)

| 格式 | 分辨率 | 帧率 | 带宽 |
|------|--------|------|------|
| MJPEG | 2560×720 | 60fps | ~8-10 MB/s |

### 下游 1 (主服务器 → PICO)

| 格式 | 分辨率 | 帧率 | 带宽 |
|------|--------|------|------|
| H.264 | 2560×720 | 60fps | ~1 MB/s (8Mbps) |

### 下游 2 (主服务器 → ROS2)

| 阶段 | 格式 | 帧率 | 带宽 |
|------|------|------|------|
| v4l2loopback | Raw YUYV422 | 30fps | ~110 MB/s (内核内存) |
| ROS2 发布 | JPEG | 30fps | ~220 KB/s × 2 = 440 KB/s |

### 关键洞察

```
1. v4l2loopback 带宽虽然大，但传输发生在内核内存
   - 无需经过 USB/网络
   - 零 CPU 拷贝开销
   - 对系统性能影响可忽略

2. ROS2 DDS 带宽很小 (440 KB/s)
   - JPEG 压缩后仅需少量带宽
   - 可通过 WiFi/以太网传输
   - 对网络压力极小

3. 整体架构平衡了:
   - USB 带宽限制 (用 MJPEG 压缩)
   - PICO 延迟需求 (用 H.264 + NVENC)
   - ROS2 可靠性需求 (用 Raw Video 零丢帧)
   - 系统资源限制 (用降帧率 + 双进程隔离)
```

---

## 总结

### 设计哲学

```
                    ┌─────────────────────────────┐
                    │     StereoVR 核心目标        │
                    │  "零丢帧 + 低延迟 + 可靠性"  │
                    └──────────────┬──────────────┘
                                   │
           ┌───────────────────────┼───────────────────────┐
           │                       │                       │
           ↓                       ↓                       ↓
    PICO 遥操作            ROS2 感知            系统资源
    (实时优先)             (可靠性优先)         (效率优先)

    ├─ H.264 NVENC        ├─ Raw Video         ├─ MJPEG 压缩
    ├─ 60fps              ├─ 0% 丢帧           ├─ 降帧率 30fps
    ├─ TCP 低延迟         ├─ 帧边界清晰        ├─ 双进程隔离
    └─                   └─                   └─
```

### 最终架构优势

| 特性 | 实现方式 | 收益 |
|------|---------|------|
| **零丢帧** | Raw Video YUYV422 | ROS2 数据完整性 100% |
| **低延迟** | H.264 + NVENC + TCP | < 50ms PICO 延迟 |
| **进程隔离** | 双进程架构 | 故障不影响，资源独立 |
| **带宽优化** | MJPEG (USB) + JPEG (ROS2) | USB 带宽节省 30x |
| **可扩展性** | 标准 V4L2 API | 易于添加新消费者 |
