# 双臂+视觉+灵巧手遥操作数据采集系统设计

## 概述

本文档描述了一个完整的遥操作数据采集系统，用于收集同步的多模态数据供机器人模仿学习训练使用。

**系统配置:**
- **输入设备 (遥操作端):** PICO 头显 + 4个Tracker + Manus手套(21DoF x2) + 头部双目相机
- **输出设备 (机器人端):** 双臂(7DoF x2) + 灵巧手(20DoF x2) + **腕部相机 x2**

---

## 闭环遥操作数据流

遥操作系统是一个**感知-动作-反馈闭环**：

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              遥操作闭环数据流                                             │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  1. 用户观察 (感知)                                                              │  │
│   │     ┌──────────────────┐                                                        │  │
│   │     │  头部立体视觉     │  ← 头部双目相机 (PC USB)                               │  │
│   │     │  (第一人称视角)   │  ← 腕部相机反馈 (机器人端)                             │  │
│   │     └────────┬─────────┘                                                        │  │
│   └──────────────┼──────────────────────────────────────────────────────────────────┘  │
│                  │                                                                      │
│                  ▼                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  2. 用户操作 (动作输入)                                                          │  │
│   │     ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │  │
│   │     │  PICO Wrist      │  │  PICO Elbow      │  │  Manus 手套      │            │  │
│   │     │  Tracker x2      │  │  Tracker x2      │  │  21 DoF x2       │            │  │
│   │     │  (手腕位姿)       │  │  (肘部约束)       │  │  (手指关节)       │            │  │
│   │     └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘            │  │
│   └──────────────┼─────────────────────┼─────────────────────┼──────────────────────┘  │
│                  │                     │                     │                         │
│                  ▼                     ▼                     ▼                         │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  3. 映射与控制 (IK 求解 + 重定向)                                                │  │
│   │                                                                                  │  │
│   │     Wrist Tracker ───→ 末端位姿目标 ───→ IK 求解 ───→ 臂关节目标                │  │
│   │     Elbow Tracker ───→ Elbow Hint ──────────────────────┘                       │  │
│   │     Manus 20 joints ───→ 关节映射 ───→ 灵巧手关节目标                            │  │
│   │                                                                                  │  │
│   └────────────────────────────────────┬────────────────────────────────────────────┘  │
│                                        │                                               │
│                                        ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  4. 机器人执行 (输出)                                                            │  │
│   │     ┌──────────────────┐  ┌──────────────────┐                                  │  │
│   │     │  双臂 (7 DoF x2) │  │  灵巧手 (20 DoF x2)│                                 │  │
│   │     │  关节位置控制     │  │  关节位置控制      │                                  │  │
│   │     └────────┬─────────┘  └────────┬─────────┘                                  │  │
│   └──────────────┼─────────────────────┼────────────────────────────────────────────┘  │
│                  │                     │                                               │
│                  ▼                     ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  5. 机器人感知 (反馈)                                                            │  │
│   │     ┌──────────────────┐  ┌──────────────────┐                                  │  │
│   │     │  左腕相机        │  │  右腕相机        │                                  │  │
│   │     │  (机器人视角)     │  │  (机器人视角)     │                                  │  │
│   │     └────────┬─────────┘  └────────┬─────────┘                                  │  │
│   └──────────────┼─────────────────────┼────────────────────────────────────────────┘  │
│                  │                     │                                               │
│                  └──────────┬──────────┘                                               │
│                             │                                                          │
│                             ▼                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐  │
│   │  6. 反馈给用户 (闭环)                                                            │  │
│   │     ┌──────────────────────────────────────────────────────────────────────┐    │  │
│   │     │  腕部相机图像 ───→ 网络传输 ───→ VR 显示 ───→ 用户观察 (回到步骤1)     │    │  │
│   │     └──────────────────────────────────────────────────────────────────────┘    │  │
│   └─────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 时间线分析

```
时间轴 ──────────────────────────────────────────────────────────────────────────→

t=0ms      t=5ms       t=10ms      t=20ms      t=25ms      t=30ms      t=50ms
  │          │           │           │           │           │           │
  ▼          ▼           ▼           ▼           ▼           ▼           ▼
┌────┐    ┌────┐     ┌────┐     ┌────┐     ┌────┐     ┌────┐     ┌────┐
│用户│    │Tracker│  │IK  │    │机器人│   │腕部 │    │网络│    │VR  │
│观察│───→│采集  │──→│求解│───→│执行 │───→│相机│───→│传输│───→│显示│
│    │    │200Hz │   │    │    │200Hz│    │30Hz│    │    │    │90Hz│
└────┘    └────┘    └────┘     └────┘     └────┘     └────┘     └────┘

                    ◀────────── 控制延迟 ~20ms ──────────▶
                    ◀──────────────── 反馈延迟 ~50ms ─────────────────▶
```

---

## 数据流全景图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    遥操作数据采集系统全景图                                           │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                     │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════════╗ │
│  ║                              输入设备层 (遥操作端)                                              ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                                               ║ │
│  ║   ┌─────────────────────────────────────────────────────────────────────────────────────┐    ║ │
│  ║   │                           PICO 4 Ultra 头显                                          │    ║ │
│  ║   │                                                                                      │    ║ │
│  ║   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐            │    ║ │
│  ║   │   │  HMD 6DoF   │   │ Controller  │   │  Tracker    │   │  Tracker    │            │    ║ │
│  ║   │   │  头部位姿    │   │  左右手柄   │   │ Left Wrist  │   │ Right Wrist │            │    ║ │
│  ║   │   │  (90Hz)     │   │  (90Hz)     │   │ 左腕 (200Hz)│   │ 右腕 (200Hz)│            │    ║ │
│  ║   │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘            │    ║ │
│  ║   │          │                 │                 │                 │                   │    ║ │
│  ║   │   ┌─────────────┐   ┌─────────────┐         │                 │                   │    ║ │
│  ║   │   │  Tracker    │   │  Tracker    │         │                 │                   │    ║ │
│  ║   │   │ Left Elbow  │   │ Right Elbow │         │                 │                   │    ║ │
│  ║   │   │ 左肘 (200Hz)│   │ 右肘 (200Hz)│         │                 │                   │    ║ │
│  ║   │   └──────┬──────┘   └──────┬──────┘         │                 │                   │    ║ │
│  ║   │          │                 │                 │                 │                   │    ║ │
│  ║   └──────────┼─────────────────┼─────────────────┼─────────────────┼───────────────────┘    ║ │
│  ║              │                 │                 │                 │                        ║ │
│  ║              │ gRPC            │                 │                 │                        ║ │
│  ║              ▼                 ▼                 ▼                 ▼                        ║ │
│  ║   ┌─────────────────────────────────────────────────────────────────────────────────────┐  ║ │
│  ║   │                    XRoboToolkit PC-Service (端口: 63901)                             │  ║ │
│  ║   │                                     │                                                │  ║ │
│  ║   │                      xrobotoolkit_sdk (Python)                                       │  ║ │
│  ║   └─────────────────────────────────────┬───────────────────────────────────────────────┘  ║ │
│  ║                                         │                                                   ║ │
│  ║   ┌─────────────────────────────────────┼───────────────────────────────────────────────┐  ║ │
│  ║   │            Manus 手套系统            │           头部双目相机                         │  ║ │
│  ║   │                                      │                                               │  ║ │
│  ║   │  ┌─────────────┐  ┌─────────────┐   │   ┌─────────────────────────────────────────┐ │  ║ │
│  ║   │  │ Left Glove  │  │ Right Glove │   │   │     USB 双目立体相机                     │ │  ║ │
│  ║   │  │ 左手 21DoF  │  │ 右手 21DoF  │   │   │     (2560x720 @ 60Hz)                   │ │  ║ │
│  ║   │  │ (90Hz)      │  │ (90Hz)      │   │   │                                         │ │  ║ │
│  ║   │  └──────┬──────┘  └──────┬──────┘   │   │   ┌───────────┐    ┌───────────┐       │ │  ║ │
│  ║   │         │                │          │   │   │ Left Eye  │    │ Right Eye │       │ │  ║ │
│  ║   │         │ BLE            │ BLE      │   │   │ 1280x720  │    │ 1280x720  │       │ │  ║ │
│  ║   │         ▼                ▼          │   │   └─────┬─────┘    └─────┬─────┘       │ │  ║ │
│  ║   │  ┌─────────────────────────────┐   │   │         │                │             │ │  ║ │
│  ║   │  │    Manus Core (PC软件)      │   │   └─────────┼────────────────┼─────────────┘ │  ║ │
│  ║   │  │    + manus_ros2_node        │   │             │                │               │  ║ │
│  ║   │  └──────────────┬──────────────┘   │             │                │               │  ║ │
│  ║   │                 │                   │             │                │               │  ║ │
│  ║   └─────────────────┼───────────────────┼─────────────┼────────────────┼───────────────┘  ║ │
│  ║                     │                   │             │                │                   ║ │
│  ╚═════════════════════╪═══════════════════╪═════════════╪════════════════╪═══════════════════╝ │
│                        │                   │             │                │                     │
│                        ▼                   ▼             ▼                ▼                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                   ROS2 话题层                                                ││
│  ├─────────────────────────────────────────────────────────────────────────────────────────────┤│
│  │                                                                                             ││
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐  ┌─────────────────────┐ ││
│  │  │     PICO 追踪数据            │  │      Manus 手部数据          │  │    视觉数据          │ ││
│  │  │                             │  │                             │  │                     │ ││
│  │  │  /pico/hmd/pose             │  │  /manus/left/joint_states   │  │  /camera/head/left  │ ││
│  │  │  /pico/tracker/left_wrist   │  │  /manus/right/joint_states  │  │  /camera/head/right │ ││
│  │  │  /pico/tracker/right_wrist  │  │                             │  │  /camera/wrist_left │ ││
│  │  │  /pico/tracker/left_elbow   │  │  每手 21 关节角度:           │  │  /camera/wrist_right│ ││
│  │  │  /pico/tracker/right_elbow  │  │  • 拇指: 4 joints           │  │                     │ ││
│  │  │                             │  │  • 食指: 4 joints           │  │                     │ ││
│  │  │  腕部 Tracker 控制双臂末端   │  │  • 中指: 4 joints           │  │                     │ ││
│  │  │  肘部 Tracker 提供 IK Hint  │  │  • 无名指: 4 joints         │  │                     │ ││
│  │  │                             │  │  • 小指: 4 joints           │  │                     │ ││
│  │  │                             │  │  • 腕部: 1 joint (不用)     │  │                     │ ││
│  │  └─────────────────────────────┘  └─────────────────────────────┘  └─────────────────────┘ ││
│  │                                                                                             ││
│  └──────────────────────────────────────────────┬──────────────────────────────────────────────┘│
│                                                 │                                               │
│                                                 ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                              遥操作映射 & IK 求解                                            ││
│  ├─────────────────────────────────────────────────────────────────────────────────────────────┤│
│  │                                                                                             ││
│  │   输入映射:                                                                                 ││
│  │   ┌───────────────────────────────────────────────────────────────────────────────────┐    ││
│  │   │  PICO Wrist Tracker (6DoF)  ──────────→  机械臂末端位姿 (6DoF)                     │    ││
│  │   │  PICO Elbow Tracker (6DoF)  ──────────→  IK Elbow Hint (约束肘部朝向)              │    ││
│  │   │  Manus 手指关节 (20 joints) ──────────→  灵巧手关节 (20 joints)                    │    ││
│  │   │  Manus 腕部关节 (1 joint)   ──────────→  忽略 (由 Wrist Tracker 控制)              │    ││
│  │   └───────────────────────────────────────────────────────────────────────────────────┘    ││
│  │                                                                                             ││
│  └──────────────────────────────────────────────┬──────────────────────────────────────────────┘│
│                                                 │                                               │
│                                                 ▼                                               │
│  ╔═══════════════════════════════════════════════════════════════════════════════════════════╗ │
│  ║                              输出设备层 (机器人端)                                          ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                                           ║ │
│  ║   ┌───────────────────────────────────────────────────────────────────────────────────┐  ║ │
│  ║   │                              双臂机器人系统                                         │  ║ │
│  ║   │                                                                                    │  ║ │
│  ║   │   ┌─────────────────────────────────┐   ┌─────────────────────────────────┐       │  ║ │
│  ║   │   │          左臂系统               │   │          右臂系统               │       │  ║ │
│  ║   │   │                                 │   │                                 │       │  ║ │
│  ║   │   │   ┌─────────────────────────┐  │   │   ┌─────────────────────────┐  │       │  ║ │
│  ║   │   │   │  机械臂 (7 DoF)          │  │   │   │  机械臂 (7 DoF)          │  │       │  ║ │
│  ║   │   │   │  • Joint 1-7 位置/速度   │  │   │   │  • Joint 1-7 位置/速度   │  │       │  ║ │
│  ║   │   │   │  • 末端力矩传感器        │  │   │   │  • 末端力矩传感器        │  │       │  ║ │
│  ║   │   │   └───────────┬─────────────┘  │   │   └───────────┬─────────────┘  │       │  ║ │
│  ║   │   │               │                 │   │               │                 │       │  ║ │
│  ║   │   │   ┌───────────▼─────────────┐  │   │   ┌───────────▼─────────────┐  │       │  ║ │
│  ║   │   │   │  灵巧手 (20 DoF)         │  │   │   │  灵巧手 (20 DoF)         │  │       │  ║ │
│  ║   │   │   │  • 拇指: 4 joints       │  │   │   │  • 拇指: 4 joints       │  │       │  ║ │
│  ║   │   │   │  • 食指: 4 joints       │  │   │   │  • 食指: 4 joints       │  │       │  ║ │
│  ║   │   │   │  • 中指: 4 joints       │  │   │   │  • 中指: 4 joints       │  │       │  ║ │
│  ║   │   │   │  • 无名指: 4 joints     │  │   │   │  • 无名指: 4 joints     │  │       │  ║ │
│  ║   │   │   │  • 小指: 4 joints       │  │   │   │  • 小指: 4 joints       │  │       │  ║ │
│  ║   │   │   └───────────┬─────────────┘  │   │   └───────────┬─────────────┘  │       │  ║ │
│  ║   │   │               │                 │   │               │                 │       │  ║ │
│  ║   │   │   ┌───────────▼─────────────┐  │   │   ┌───────────▼─────────────┐  │       │  ║ │
│  ║   │   │   │  腕部相机 (30Hz)         │  │   │   │  腕部相机 (30Hz)         │  │       │  ║ │
│  ║   │   │   │  640x480 RGB            │  │   │   │  640x480 RGB            │  │       │  ║ │
│  ║   │   │   └─────────────────────────┘  │   │   └─────────────────────────┘  │       │  ║ │
│  ║   │   │                                 │   │                                 │       │  ║ │
│  ║   │   └─────────────────────────────────┘   └─────────────────────────────────┘       │  ║ │
│  ║   │                                                                                    │  ║ │
│  ║   │   发布 ROS2 话题:                                                                  │  ║ │
│  ║   │   • /robot/left_arm/joint_states    (JointState, 7 DoF)                           │  ║ │
│  ║   │   • /robot/right_arm/joint_states   (JointState, 7 DoF)                           │  ║ │
│  ║   │   • /robot/left_hand/joint_states   (JointState, 20 DoF)                          │  ║ │
│  ║   │   • /robot/right_hand/joint_states  (JointState, 20 DoF)                          │  ║ │
│  ║   │   • /camera/wrist_left/image_raw    (Image)                                       │  ║ │
│  ║   │   • /camera/wrist_right/image_raw   (Image)                                       │  ║ │
│  ║   │                                                                                    │  ║ │
│  ║   └───────────────────────────────────────────────────────────────────────────────────┘  ║ │
│  ║                                                                                           ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════════════════════╝ │
│                                                 │                                               │
│                                                 ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                            统一数据采集节点 (teleop_data_collector)                          ││
│  ├─────────────────────────────────────────────────────────────────────────────────────────────┤│
│  │                                                                                             ││
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────┐ ││
│  │  │                        message_filters.ApproximateTimeSynchronizer                     │ ││
│  │  │                                                                                        │ ││
│  │  │   同步话题:                                slop = 50ms                                 │ ││
│  │  │   • /pico/tracker/* (4个)                  queue_size = 10                             │ ││
│  │  │   • /manus/*/joint_states (2个)            输出频率: 30Hz                              │ ││
│  │  │   • /robot/*/joint_states (4个)                                                        │ ││
│  │  │   • /camera/* (4个)                                                                    │ ││
│  │  └───────────────────────────────────────────────────────────────────────────────────────┘ ││
│  │                                                                                             ││
│  └──────────────────────────────────────────────┬──────────────────────────────────────────────┘│
│                                                 │                                               │
│                                                 ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐│
│  │                                    HDF5 数据存储                                             ││
│  ├─────────────────────────────────────────────────────────────────────────────────────────────┤│
│  │                                                                                             ││
│  │   episode_0001.hdf5                                                                         ││
│  │   │                                                                                         ││
│  │   ├── /observations                          # 观测数据 (机器人状态)                        ││
│  │   │   ├── arm_qpos         [T, 14]           # 双臂关节位置 (7+7)                           ││
│  │   │   ├── arm_qvel         [T, 14]           # 双臂关节速度                                 ││
│  │   │   ├── hand_qpos        [T, 40]           # 灵巧手关节位置 (20+20)                       ││
│  │   │   └── images/                            # 多视角图像                                   ││
│  │   │       ├── head_left    [T, 480, 640, 3]  # 头部左眼                                     ││
│  │   │       ├── head_right   [T, 480, 640, 3]  # 头部右眼                                     ││
│  │   │       ├── wrist_left   [T, 480, 640, 3]  # 左腕相机                                     ││
│  │   │       └── wrist_right  [T, 480, 640, 3]  # 右腕相机                                     ││
│  │   │                                                                                         ││
│  │   ├── /action                                # 动作数据 (遥操作输入)                        ││
│  │   │   ├── arm_action       [T, 14]           # 目标臂关节位置                               ││
│  │   │   └── hand_action      [T, 40]           # 目标手指关节位置                             ││
│  │   │                                                                                         ││
│  │   ├── /teleop                                # 原始遥操作数据 (用于分析/调试)               ││
│  │   │   ├── hmd_pose         [T, 7]            # 头显位姿 [x,y,z,qx,qy,qz,qw]                 ││
│  │   │   ├── left_wrist       [T, 7]            # 左腕 Tracker 位姿                            ││
│  │   │   ├── right_wrist      [T, 7]            # 右腕 Tracker 位姿                            ││
│  │   │   ├── left_elbow       [T, 7]            # 左肘 Tracker 位姿                            ││
│  │   │   ├── right_elbow      [T, 7]            # 右肘 Tracker 位姿                            ││
│  │   │   ├── manus_left       [T, 21]           # Manus 左手原始关节                           ││
│  │   │   └── manus_right      [T, 21]           # Manus 右手原始关节                           ││
│  │   │                                                                                         ││
│  │   └── /metadata                              # 元数据                                       ││
│  │       ├── timestamp        [T]               # 纳秒时间戳                                   ││
│  │       ├── episode_id       scalar            # Episode 编号                                 ││
│  │       ├── task_name        string            # 任务名称                                     ││
│  │       └── operator_id      string            # 操作者 ID                                    ││
│  │                                                                                             ││
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 自由度对照表

### 输入设备 (遥操作端)

| 设备 | 自由度 | 用途 | 频率 |
|------|--------|------|------|
| PICO HMD | 6 DoF | 头部位姿 (观察视角) | 90 Hz |
| PICO Left Wrist Tracker | 6 DoF | **控制左臂末端位姿** | 200 Hz |
| PICO Right Wrist Tracker | 6 DoF | **控制右臂末端位姿** | 200 Hz |
| PICO Left Elbow Tracker | 6 DoF | 提供 IK Elbow Hint | 200 Hz |
| PICO Right Elbow Tracker | 6 DoF | 提供 IK Elbow Hint | 200 Hz |
| Manus Left Glove | **21 DoF** | 控制左灵巧手 (20 joints 映射) | 90 Hz |
| Manus Right Glove | **21 DoF** | 控制右灵巧手 (20 joints 映射) | 90 Hz |
| 头部双目相机 | - | 操作者第一人称视野 | 60 Hz |

### 输出设备 (机器人端)

| 设备 | 自由度 | 控制输入来源 | 频率 |
|------|--------|-------------|------|
| 左机械臂 | 7 DoF | PICO Left Wrist Tracker → IK | 200 Hz |
| 右机械臂 | 7 DoF | PICO Right Wrist Tracker → IK | 200 Hz |
| 左灵巧手 | **20 DoF** | Manus Left Glove (21→20 映射) | 90 Hz |
| 右灵巧手 | **20 DoF** | Manus Right Glove (21→20 映射) | 90 Hz |
| 左腕相机 | - | 机器人视角反馈 | 30 Hz |
| 右腕相机 | - | 机器人视角反馈 | 30 Hz |

### Manus 21 DoF → 灵巧手 20 DoF 映射

```
Manus 手套 (21 DoF):                    灵巧手 (20 DoF):
┌────────────────────────┐              ┌────────────────────────┐
│ 腕部 (1 joint) ────────┼─── 忽略 ───→ │ (由 Wrist Tracker 控制) │
│                        │              │                        │
│ 拇指 (4 joints)  ──────┼── 1:1 映射 ─→│ 拇指 (4 joints)         │
│ 食指 (4 joints)  ──────┼── 1:1 映射 ─→│ 食指 (4 joints)         │
│ 中指 (4 joints)  ──────┼── 1:1 映射 ─→│ 中指 (4 joints)         │
│ 无名指 (4 joints) ─────┼── 1:1 映射 ─→│ 无名指 (4 joints)       │
│ 小指 (4 joints)  ──────┼── 1:1 映射 ─→│ 小指 (4 joints)         │
└────────────────────────┘              └────────────────────────┘
     21 joints                               20 joints
```

**映射逻辑:**
- Manus 腕部关节 (wrist flexion) 被**忽略**，因为手腕位姿由 PICO Wrist Tracker 控制
- 20个手指关节直接 1:1 映射到灵巧手

---

## ROS2 话题架构设计

### 设计原则

为了便于时间同步和数据采集，话题按照**数据来源**分组：

1. **遥操作端话题** (`/teleop/*`) - 用户输入设备
2. **机器人端话题** (`/robot/*`) - 机器人状态和感知 (包括腕部相机)
3. **命令话题** (`/cmd/*`) - 控制命令

### 话题命名规范

```
/teleop/               # 遥操作端 (用户输入)
├── pico/
│   ├── hmd/pose                    # 头显位姿
│   ├── tracker/left_wrist          # 左腕 Tracker
│   ├── tracker/right_wrist         # 右腕 Tracker
│   ├── tracker/left_elbow          # 左肘 Tracker
│   └── tracker/right_elbow         # 右肘 Tracker
├── manus/
│   ├── left/joint_states           # Manus 左手 21 关节
│   └── right/joint_states          # Manus 右手 21 关节
└── camera/
    └── head/                       # 头部双目相机 (用户视角)
        ├── left/image_raw
        └── right/image_raw

/robot/                # 机器人端 (状态 + 感知)
├── arm/
│   ├── left/joint_states           # 左臂 7 关节状态
│   └── right/joint_states          # 右臂 7 关节状态
├── hand/
│   ├── left/joint_states           # 左灵巧手 20 关节状态
│   └── right/joint_states          # 右灵巧手 20 关节状态
└── camera/                         # 腕部相机 (机器人视角) ← 属于机器人端
    ├── wrist_left/image_raw
    └── wrist_right/image_raw

/cmd/                  # 控制命令
├── arm/
│   ├── left/joint_position         # 左臂关节位置命令
│   └── right/joint_position        # 右臂关节位置命令
└── hand/
    ├── left/joint_position         # 左手关节位置命令
    └── right/joint_position        # 右手关节位置命令
```

### 完整话题列表

#### 遥操作输入话题 (来自用户设备)

| 话题 | 消息类型 | 频率 | 来源 | 描述 |
|------|---------|------|------|------|
| `/teleop/pico/hmd/pose` | PoseStamped | 90Hz | PICO 头显 | 头显 6DoF 位姿 |
| `/teleop/pico/tracker/left_wrist` | PoseStamped | 200Hz | PICO Tracker | 左腕 → 左臂末端目标 |
| `/teleop/pico/tracker/right_wrist` | PoseStamped | 200Hz | PICO Tracker | 右腕 → 右臂末端目标 |
| `/teleop/pico/tracker/left_elbow` | PoseStamped | 200Hz | PICO Tracker | 左肘 → IK Hint |
| `/teleop/pico/tracker/right_elbow` | PoseStamped | 200Hz | PICO Tracker | 右肘 → IK Hint |
| `/teleop/manus/left/joint_states` | JointState | 90Hz | Manus SDK | 左手 21 关节 |
| `/teleop/manus/right/joint_states` | JointState | 90Hz | Manus SDK | 右手 21 关节 |
| `/teleop/camera/head/left/image_raw` | Image | 60Hz | PC USB 相机 | 头部左眼 |
| `/teleop/camera/head/right/image_raw` | Image | 60Hz | PC USB 相机 | 头部右眼 |

#### 机器人状态话题 (来自机器人，包括腕部相机)

| 话题 | 消息类型 | 频率 | 来源 | 描述 |
|------|---------|------|------|------|
| `/robot/arm/left/joint_states` | JointState | 200Hz | 机械臂控制器 | 左臂 7 关节状态 |
| `/robot/arm/right/joint_states` | JointState | 200Hz | 机械臂控制器 | 右臂 7 关节状态 |
| `/robot/hand/left/joint_states` | JointState | 90Hz | 灵巧手控制器 | 左手 20 关节状态 |
| `/robot/hand/right/joint_states` | JointState | 90Hz | 灵巧手控制器 | 右手 20 关节状态 |
| `/robot/camera/wrist_left/image_raw` | Image | 30Hz | **机器人腕部** | 左腕相机 (机器人视角) |
| `/robot/camera/wrist_right/image_raw` | Image | 30Hz | **机器人腕部** | 右腕相机 (机器人视角) |

#### 控制命令话题 (发送给机器人)

| 话题 | 消息类型 | 频率 | 描述 |
|------|---------|------|------|
| `/cmd/arm/left/joint_position` | Float64MultiArray | 200Hz | 左臂目标关节位置 |
| `/cmd/arm/right/joint_position` | Float64MultiArray | 200Hz | 右臂目标关节位置 |
| `/cmd/hand/left/joint_position` | Float64MultiArray | 90Hz | 左手目标关节位置 |
| `/cmd/hand/right/joint_position` | Float64MultiArray | 90Hz | 右手目标关节位置 |

---

## 时间同步策略

### 核心原则：机器人端必须硬同步

**关键洞察**: 对于模仿学习数据采集，最重要的是确保 **机器人端数据的严格同步**：

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           机器人端硬同步要求                                              │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   在同一物理时刻 t，必须同时采集:                                                         │
│                                                                                         │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                      │
│   │  机械臂关节角    │   │  灵巧手关节角    │   │  腕部相机画面    │                      │
│   │  (14 DoF)       │   │  (40 DoF)       │   │  (2 images)     │                      │
│   └────────┬────────┘   └────────┬────────┘   └────────┬────────┘                      │
│            │                     │                     │                               │
│            └─────────────────────┼─────────────────────┘                               │
│                                  ▼                                                      │
│                        ┌─────────────────┐                                             │
│                        │  同一时间戳 t   │                                             │
│                        │  (硬件触发同步)  │                                             │
│                        └─────────────────┘                                             │
│                                                                                         │
│   为什么? 因为这三者定义了机器人在时刻 t 的完整状态:                                       │
│   • 关节角 → 机器人姿态                                                                  │
│   • 相机画面 → 该姿态下看到的场景                                                         │
│                                                                                         │
│   如果不同步，训练数据会有因果错位！                                                      │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 时钟域分析

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              时钟域分析                                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   时钟域 A: PC                    时钟域 B: 机器人控制器           时钟域 C: PICO        │
│   ┌─────────────────────┐        ┌─────────────────────┐        ┌─────────────────────┐│
│   │ • 头部双目相机       │        │ • 双臂关节编码器     │        │ • HMD/Tracker       ││
│   │ • Manus SDK         │        │ • 灵巧手关节编码器   │        │ • 通过 gRPC 同步    ││
│   │ • ROS2 节点         │        │ • 腕部相机          │        │                     ││
│   └─────────────────────┘        └─────────┬───────────┘        └─────────────────────┘│
│            │                                │                            │              │
│            │◀─── NTP/PTP 同步 ────────────▶│◀─── 网络延迟 ─────────────▶│              │
│                                             │                                           │
│                                    ┌────────▼────────┐                                  │
│                                    │  硬件触发同步    │                                  │
│                                    │  (同一控制周期)  │                                  │
│                                    └─────────────────┘                                  │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 推荐方案：分层时间同步

#### 第一层：机器人端硬同步 (最关键)

机器人控制器内部实现硬件级同步：

```python
"""
机器人端硬同步实现 (在机器人控制器内部)

所有数据在同一个控制周期内采集，共享同一个时间戳
"""

class RobotStatePublisher:
    """机器人状态发布器 - 硬同步版本"""

    def control_loop(self):
        """控制周期回调 (1kHz)"""
        # 在同一个控制周期内，原子性地读取所有传感器
        timestamp = self.get_hardware_timestamp()  # 硬件时钟

        # 1. 读取机械臂关节编码器 (同步读取)
        arm_left_joints = self.arm_left.read_encoders()   # 7 DoF
        arm_right_joints = self.arm_right.read_encoders() # 7 DoF

        # 2. 读取灵巧手关节编码器 (同步读取)
        hand_left_joints = self.hand_left.read_encoders()   # 20 DoF
        hand_right_joints = self.hand_right.read_encoders() # 20 DoF

        # 3. 触发腕部相机采集 (硬件触发，与编码器同步)
        wrist_left_image = self.wrist_cam_left.capture()   # 硬件触发
        wrist_right_image = self.wrist_cam_right.capture() # 硬件触发

        # 所有数据使用同一个时间戳发布
        self.publish_synced_state(
            timestamp=timestamp,
            arm_joints=np.concatenate([arm_left_joints, arm_right_joints]),  # 14 DoF
            hand_joints=np.concatenate([hand_left_joints, hand_right_joints]), # 40 DoF
            wrist_images=[wrist_left_image, wrist_right_image]
        )
```

#### 第二层：跨设备软同步

遥操作端数据 (PICO、Manus、头部相机) 与机器人端数据的对齐：

以**机器人腕部相机 (30Hz)** 作为同步基准，因为它是闭环中最慢且最关键的反馈环节。

```python
"""
分层时间同步策略:

1. 底层同步: PTP (IEEE 1588) 或 NTP 保证各设备时钟偏差 < 1ms
2. 中层同步: ROS2 message_filters 按时间戳对齐
3. 高层同步: 以机器人腕部相机为基准，统一输出 30Hz
"""

import message_filters
from sensor_msgs.msg import Image, JointState
from geometry_msgs.msg import PoseStamped


class TeleopDataCollector(Node):
    """分层时间同步的数据采集器"""

    def __init__(self):
        super().__init__('teleop_data_collector')

        # ========== 第一组：遥操作输入 (高频，需要降采样) ==========
        self.teleop_subs = [
            message_filters.Subscriber(self, PoseStamped, '/teleop/pico/tracker/left_wrist'),
            message_filters.Subscriber(self, PoseStamped, '/teleop/pico/tracker/right_wrist'),
            message_filters.Subscriber(self, PoseStamped, '/teleop/pico/tracker/left_elbow'),
            message_filters.Subscriber(self, PoseStamped, '/teleop/pico/tracker/right_elbow'),
            message_filters.Subscriber(self, JointState, '/teleop/manus/left/joint_states'),
            message_filters.Subscriber(self, JointState, '/teleop/manus/right/joint_states'),
        ]

        # ========== 第二组：机器人状态 (高频) ==========
        self.robot_subs = [
            message_filters.Subscriber(self, JointState, '/robot/arm/left/joint_states'),
            message_filters.Subscriber(self, JointState, '/robot/arm/right/joint_states'),
            message_filters.Subscriber(self, JointState, '/robot/hand/left/joint_states'),
            message_filters.Subscriber(self, JointState, '/robot/hand/right/joint_states'),
        ]

        # ========== 第三组：视觉数据 ==========
        # 头部相机: 遥操作端 (60Hz)
        # 腕部相机: 机器人端 (30Hz) ← 作为同步基准
        self.camera_subs = [
            message_filters.Subscriber(self, Image, '/teleop/camera/head/left/image_raw'),
            message_filters.Subscriber(self, Image, '/teleop/camera/head/right/image_raw'),
            message_filters.Subscriber(self, Image, '/robot/camera/wrist_left/image_raw'),   # 机器人端
            message_filters.Subscriber(self, Image, '/robot/camera/wrist_right/image_raw'),  # 机器人端
        ]

        # 所有话题联合同步
        all_subs = self.teleop_subs + self.robot_subs + self.camera_subs

        self.sync = message_filters.ApproximateTimeSynchronizer(
            all_subs,
            queue_size=10,
            slop=0.05,  # 50ms 容忍度
        )
        self.sync.registerCallback(self.synced_callback)

    def synced_callback(
        self,
        # 遥操作输入 (6个)
        left_wrist, right_wrist, left_elbow, right_elbow,
        manus_left, manus_right,
        # 机器人状态 (4个)
        arm_left, arm_right, hand_left, hand_right,
        # 相机 (4个): 2个来自遥操作端，2个来自机器人端
        head_left, head_right, wrist_left, wrist_right
    ):
        """
        所有 14 个话题已按时间戳对齐
        输出频率由最慢的话题 (机器人腕部相机 30Hz) 决定
        """
        pass
```

### 关键设计决策

| 问题 | 方案 | 理由 |
|------|------|------|
| **以谁的时钟为准？** | 机器人控制器时钟 | 动作执行是核心，其他数据对齐到机器人 |
| **输出频率？** | 30 Hz | 由最慢的传感器 (机器人腕部相机) 决定 |
| **同步容忍度？** | 50ms | 人类反应时间 ~100ms，50ms 足够 |
| **腕部相机归属？** | 机器人端 | 它是机器人的感知设备，与机器人状态同源 |

### 数据对齐图示

```
时间轴 ──────────────────────────────────────────────────────────────────────────────→
         t₀         t₁         t₂         t₃         t₄         t₅
         │          │          │          │          │          │
         ▼          ▼          ▼          ▼          ▼          ▼

[遥操作端]
Tracker (200Hz)
    ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○
              ↓              ↓              ↓              ↓
Manus (90Hz)
    ○     ○     ○     ○     ○     ○     ○     ○     ○     ○     ○     ○
              ↓              ↓              ↓              ↓
Head Camera (60Hz)
    ○        ○        ○        ○        ○        ○        ○        ○
              ↓              ↓              ↓              ↓

[机器人端]
Robot State (200Hz)
    ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○  ○
              ↓              ↓              ↓              ↓
Wrist Camera (30Hz) ◀─── 同步基准 (机器人端)
    ●                 ●                 ●                 ●
    │                 │                 │                 │
    ▼                 ▼                 ▼                 ▼

[输出]
Synced Data (30Hz)
    █                 █                 █                 █

    每个 █ 包含:
    • /teleop/* 数据 (最近邻采样)
    • /robot/* 数据 (最近邻采样)
    • 4 张图像 (时间戳在 50ms 内)
```

---

## 数据存储格式

### HDF5 结构 (ACT/Diffusion Policy 兼容)

```python
import h5py
import numpy as np

class HDF5Writer:
    """遥操作数据 HDF5 写入器"""

    def __init__(self, filepath: str, max_timesteps: int = 3000):
        self.file = h5py.File(filepath, 'w')
        self.max_timesteps = max_timesteps
        self.current_idx = 0

        self._create_datasets()

    def _create_datasets(self):
        """创建数据集结构"""
        obs = self.file.create_group('observations')

        # 机器人状态
        obs.create_dataset('arm_qpos', shape=(self.max_timesteps, 14), dtype='float32')
        obs.create_dataset('arm_qvel', shape=(self.max_timesteps, 14), dtype='float32')
        obs.create_dataset('hand_qpos', shape=(self.max_timesteps, 40), dtype='float32')

        # 图像 (压缩存储)
        images = obs.create_group('images')
        for cam in ['head_left', 'head_right', 'wrist_left', 'wrist_right']:
            images.create_dataset(
                cam,
                shape=(self.max_timesteps, 480, 640, 3),
                dtype='uint8',
                compression='gzip',
                compression_opts=4,
                chunks=(1, 480, 640, 3)
            )

        # 动作
        action = self.file.create_group('action')
        action.create_dataset('arm_action', shape=(self.max_timesteps, 14), dtype='float32')
        action.create_dataset('hand_action', shape=(self.max_timesteps, 40), dtype='float32')

        # 遥操作原始数据
        teleop = self.file.create_group('teleop')
        teleop.create_dataset('hmd_pose', shape=(self.max_timesteps, 7), dtype='float32')
        teleop.create_dataset('left_wrist', shape=(self.max_timesteps, 7), dtype='float32')
        teleop.create_dataset('right_wrist', shape=(self.max_timesteps, 7), dtype='float32')
        teleop.create_dataset('left_elbow', shape=(self.max_timesteps, 7), dtype='float32')
        teleop.create_dataset('right_elbow', shape=(self.max_timesteps, 7), dtype='float32')
        teleop.create_dataset('manus_left', shape=(self.max_timesteps, 21), dtype='float32')
        teleop.create_dataset('manus_right', shape=(self.max_timesteps, 21), dtype='float32')

        # 时间戳
        self.file.create_dataset('timestamp', shape=(self.max_timesteps,), dtype='float64')

    def add_frame(self, data: dict):
        """添加一帧数据"""
        idx = self.current_idx

        # 机器人状态
        self.file['observations/arm_qpos'][idx] = data['arm_qpos']
        self.file['observations/hand_qpos'][idx] = data['hand_qpos']

        # 图像
        for cam in ['head_left', 'head_right', 'wrist_left', 'wrist_right']:
            self.file[f'observations/images/{cam}'][idx] = data['images'][cam]

        # 动作
        self.file['action/arm_action'][idx] = data['arm_action']
        self.file['action/hand_action'][idx] = data['hand_action']

        # 遥操作数据
        self.file['teleop/left_wrist'][idx] = data['left_wrist']
        self.file['teleop/right_wrist'][idx] = data['right_wrist']
        self.file['teleop/manus_left'][idx] = data['manus_left']
        self.file['teleop/manus_right'][idx] = data['manus_right']

        self.file['timestamp'][idx] = data['timestamp']
        self.current_idx += 1
```

---

## Manus ROS2 节点

Manus 手套通过独立的 ROS2 节点从 SDK 读取数据并发布：

```python
#!/usr/bin/env python3
"""
Manus 手套 ROS2 节点
从 Manus Core SDK 读取手指关节数据并发布到 ROS2
"""

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import JointState
from manus_core import ManusSDK  # Manus 官方 Python SDK


class ManusNode(Node):
    """Manus 手套 ROS2 节点"""

    FINGER_JOINTS = [
        # 腕部 (1 joint) - 将被忽略，但仍然采集
        'wrist_flexion',
        # 拇指 (4 joints)
        'thumb_cmc_flexion', 'thumb_mcp_flexion', 'thumb_ip_flexion', 'thumb_abd',
        # 食指 (4 joints)
        'index_mcp_flexion', 'index_pip_flexion', 'index_dip_flexion', 'index_abd',
        # 中指 (4 joints)
        'middle_mcp_flexion', 'middle_pip_flexion', 'middle_dip_flexion', 'middle_abd',
        # 无名指 (4 joints)
        'ring_mcp_flexion', 'ring_pip_flexion', 'ring_dip_flexion', 'ring_abd',
        # 小指 (4 joints)
        'pinky_mcp_flexion', 'pinky_pip_flexion', 'pinky_dip_flexion', 'pinky_abd',
    ]

    def __init__(self):
        super().__init__('manus_node')

        # 初始化 Manus SDK
        self.sdk = ManusSDK()
        self.sdk.connect()

        # 发布器
        self.left_pub = self.create_publisher(JointState, '/manus/left/joint_states', 10)
        self.right_pub = self.create_publisher(JointState, '/manus/right/joint_states', 10)

        # 定时器 (90Hz)
        self.timer = self.create_timer(1.0/90.0, self.publish_callback)

        self.get_logger().info('Manus node initialized')

    def publish_callback(self):
        """发布手套数据"""
        timestamp = self.get_clock().now().to_msg()

        # 获取左手数据
        left_joints = self.sdk.get_left_hand_joints()  # 返回 21 个关节角度
        left_msg = JointState()
        left_msg.header.stamp = timestamp
        left_msg.header.frame_id = 'manus_left'
        left_msg.name = self.FINGER_JOINTS
        left_msg.position = left_joints.tolist()
        self.left_pub.publish(left_msg)

        # 获取右手数据
        right_joints = self.sdk.get_right_hand_joints()
        right_msg = JointState()
        right_msg.header.stamp = timestamp
        right_msg.header.frame_id = 'manus_right'
        right_msg.name = self.FINGER_JOINTS
        right_msg.position = right_joints.tolist()
        self.right_pub.publish(right_msg)


def main(args=None):
    rclpy.init(args=args)
    node = ManusNode()
    rclpy.spin(node)
    node.sdk.disconnect()
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

---

## 完整采集节点

```python
#!/usr/bin/env python3
"""
统一遥操作数据采集节点
支持: PICO (4 Trackers) + Manus (21 DoF x2) + 双臂 (7 DoF x2) + 灵巧手 (20 DoF x2) + 4相机
"""

import rclpy
from rclpy.node import Node
import message_filters
from sensor_msgs.msg import Image, JointState
from geometry_msgs.msg import PoseStamped
from std_srvs.srv import Trigger
from cv_bridge import CvBridge
import cv2
import h5py
import numpy as np
from datetime import datetime
from pathlib import Path


class TeleopDataCollector(Node):
    def __init__(self):
        super().__init__('teleop_data_collector')

        # 参数
        self.declare_parameter('output_dir', '/data/teleop_episodes')
        self.declare_parameter('episode_max_length', 3000)  # 100s @ 30Hz
        self.declare_parameter('image_resize', [640, 480])
        self.declare_parameter('sync_slop', 0.05)  # 50ms

        self.output_dir = Path(self.get_parameter('output_dir').value)
        self.max_length = self.get_parameter('episode_max_length').value
        self.img_size = tuple(self.get_parameter('image_resize').value)
        self.sync_slop = self.get_parameter('sync_slop').value

        self.output_dir.mkdir(parents=True, exist_ok=True)
        self.bridge = CvBridge()

        # 状态
        self.recording = False
        self.current_writer = None
        self.episode_count = self._count_existing_episodes()

        # 订阅器
        self._setup_subscribers()

        # 服务
        self.create_service(Trigger, 'start_recording', self._start_recording)
        self.create_service(Trigger, 'stop_recording', self._stop_recording)

        self.get_logger().info(f'TeleopDataCollector ready. Existing episodes: {self.episode_count}')

    def _count_existing_episodes(self) -> int:
        """统计已有 episode 数量"""
        return len(list(self.output_dir.glob('episode_*.hdf5')))

    def _setup_subscribers(self):
        """设置消息过滤器订阅"""

        subs = [
            # PICO Trackers (4个, 200Hz → 降采样到 30Hz)
            message_filters.Subscriber(self, PoseStamped, '/pico/tracker/left_wrist'),
            message_filters.Subscriber(self, PoseStamped, '/pico/tracker/right_wrist'),
            message_filters.Subscriber(self, PoseStamped, '/pico/tracker/left_elbow'),
            message_filters.Subscriber(self, PoseStamped, '/pico/tracker/right_elbow'),

            # Manus 手套 (2个, 21 DoF each)
            message_filters.Subscriber(self, JointState, '/manus/left/joint_states'),
            message_filters.Subscriber(self, JointState, '/manus/right/joint_states'),

            # 机器人臂 (2个, 7 DoF each)
            message_filters.Subscriber(self, JointState, '/robot/left_arm/joint_states'),
            message_filters.Subscriber(self, JointState, '/robot/right_arm/joint_states'),

            # 灵巧手 (2个, 20 DoF each)
            message_filters.Subscriber(self, JointState, '/robot/left_hand/joint_states'),
            message_filters.Subscriber(self, JointState, '/robot/right_hand/joint_states'),

            # 相机 (4个)
            message_filters.Subscriber(self, Image, '/camera/head/left/image_raw'),
            message_filters.Subscriber(self, Image, '/camera/head/right/image_raw'),
            message_filters.Subscriber(self, Image, '/camera/wrist_left/image_raw'),
            message_filters.Subscriber(self, Image, '/camera/wrist_right/image_raw'),
        ]

        self.sync = message_filters.ApproximateTimeSynchronizer(
            subs,
            queue_size=10,
            slop=self.sync_slop,
        )
        self.sync.registerCallback(self._synced_callback)

    def _synced_callback(
        self,
        left_wrist, right_wrist, left_elbow, right_elbow,
        manus_left, manus_right,
        arm_left, arm_right,
        hand_left, hand_right,
        head_left, head_right, wrist_left, wrist_right
    ):
        """同步数据回调"""

        if not self.recording or self.current_writer is None:
            return

        # 提取数据
        data = {
            # 遥操作姿态 (用于分析/调试)
            'left_wrist': self._pose_to_array(left_wrist),
            'right_wrist': self._pose_to_array(right_wrist),
            'left_elbow': self._pose_to_array(left_elbow),
            'right_elbow': self._pose_to_array(right_elbow),

            # Manus 原始数据 (21 joints each)
            'manus_left': np.array(manus_left.position, dtype=np.float32),
            'manus_right': np.array(manus_right.position, dtype=np.float32),

            # 机器人臂状态 (7 DoF each → 14 total)
            'arm_qpos': np.concatenate([
                np.array(arm_left.position, dtype=np.float32),
                np.array(arm_right.position, dtype=np.float32)
            ]),
            'arm_qvel': np.concatenate([
                np.array(arm_left.velocity, dtype=np.float32) if arm_left.velocity else np.zeros(7),
                np.array(arm_right.velocity, dtype=np.float32) if arm_right.velocity else np.zeros(7)
            ]),

            # 灵巧手状态 (20 DoF each → 40 total)
            'hand_qpos': np.concatenate([
                np.array(hand_left.position, dtype=np.float32),
                np.array(hand_right.position, dtype=np.float32)
            ]),

            # 动作 = 当前机器人状态 (用于模仿学习)
            'arm_action': np.concatenate([
                np.array(arm_left.position, dtype=np.float32),
                np.array(arm_right.position, dtype=np.float32)
            ]),
            'hand_action': np.concatenate([
                np.array(hand_left.position, dtype=np.float32),
                np.array(hand_right.position, dtype=np.float32)
            ]),

            # 图像
            'images': {
                'head_left': self._process_image(head_left),
                'head_right': self._process_image(head_right),
                'wrist_left': self._process_image(wrist_left),
                'wrist_right': self._process_image(wrist_right),
            },

            # 时间戳
            'timestamp': left_wrist.header.stamp.sec + left_wrist.header.stamp.nanosec * 1e-9,
        }

        # 写入 HDF5
        self.current_writer.add_frame(data)

        # 检查长度限制
        if self.current_writer.current_idx >= self.max_length:
            self.get_logger().warn('Episode reached max length, auto stopping...')
            self._stop_recording_internal()

    def _pose_to_array(self, pose_msg: PoseStamped) -> np.ndarray:
        """PoseStamped -> [x, y, z, qx, qy, qz, qw]"""
        p = pose_msg.pose
        return np.array([
            p.position.x, p.position.y, p.position.z,
            p.orientation.x, p.orientation.y, p.orientation.z, p.orientation.w
        ], dtype=np.float32)

    def _process_image(self, img_msg: Image) -> np.ndarray:
        """Image msg -> resized numpy array"""
        cv_img = self.bridge.imgmsg_to_cv2(img_msg, 'rgb8')
        resized = cv2.resize(cv_img, self.img_size)
        return resized

    def _start_recording(self, request, response):
        """开始录制"""
        if self.recording:
            response.success = False
            response.message = 'Already recording'
            return response

        self.episode_count += 1
        filepath = self.output_dir / f'episode_{self.episode_count:04d}.hdf5'
        self.current_writer = HDF5Writer(str(filepath), self.max_length)
        self.recording = True

        self.get_logger().info(f'Started recording: {filepath}')
        response.success = True
        response.message = f'Recording to {filepath}'
        return response

    def _stop_recording(self, request, response):
        """停止录制 (服务接口)"""
        success, message = self._stop_recording_internal()
        response.success = success
        response.message = message
        return response

    def _stop_recording_internal(self) -> tuple:
        """停止录制 (内部调用)"""
        if not self.recording:
            return False, 'Not recording'

        self.recording = False
        if self.current_writer:
            frames = self.current_writer.current_idx
            self.current_writer.finalize()
            self.current_writer = None
            self.get_logger().info(f'Stopped recording. Total frames: {frames}')
            return True, f'Recording stopped. Frames: {frames}'

        return True, 'Recording stopped'


def main(args=None):
    rclpy.init(args=args)
    node = TeleopDataCollector()
    rclpy.spin(node)
    rclpy.shutdown()


if __name__ == '__main__':
    main()
```

---

## Launch 文件

```python
# teleop_collection.launch.py
from launch import LaunchDescription
from launch_ros.actions import Node

def generate_launch_description():
    return LaunchDescription([
        # PICO Bridge (Tracker 数据)
        Node(
            package='pico_bridge',
            executable='pico_bridge_node',
            parameters=[{
                'publish_rate': 200.0,
                'enable_trackers': True,
                'num_trackers': 4,
                'tracker_0_role': 'left_wrist',
                'tracker_1_role': 'right_wrist',
                'tracker_2_role': 'left_elbow',
                'tracker_3_role': 'right_elbow',
            }]
        ),

        # Manus 手套节点
        Node(
            package='manus_ros2',
            executable='manus_node',
            parameters=[{
                'publish_rate': 90.0,
            }]
        ),

        # 头部双目相机
        Node(
            package='usb_cam',
            executable='usb_cam_node_exe',
            name='head_stereo_cam',
            parameters=[{
                'video_device': '/dev/video0',
                'framerate': 60.0,
                'image_width': 2560,
                'image_height': 720,
            }],
            remappings=[
                ('image_raw', '/camera/head/stereo/image_raw'),
            ]
        ),

        # 立体图像分割器 (左右眼)
        Node(
            package='stereo_splitter',
            executable='splitter_node',
            parameters=[{
                'input_topic': '/camera/head/stereo/image_raw',
                'left_topic': '/camera/head/left/image_raw',
                'right_topic': '/camera/head/right/image_raw',
            }]
        ),

        # 数据采集节点
        Node(
            package='teleop_collection',
            executable='teleop_data_collector',
            parameters=[{
                'output_dir': '/data/teleop_episodes',
                'episode_max_length': 3000,
                'sync_slop': 0.05,
                'image_resize': [640, 480],
            }]
        ),
    ])
```

---

## 使用方法

```bash
# 1. 启动采集系统
ros2 launch teleop_collection teleop_collection.launch.py

# 2. 开始录制
ros2 service call /start_recording std_srvs/srv/Trigger

# 3. 执行遥操作任务...

# 4. 停止录制
ros2 service call /stop_recording std_srvs/srv/Trigger

# 5. 验证数据
python3 -c "
import h5py
with h5py.File('episode_0001.hdf5', 'r') as f:
    print('Keys:', list(f.keys()))
    print('Arm qpos shape:', f['observations/arm_qpos'].shape)
    print('Hand qpos shape:', f['observations/hand_qpos'].shape)
    print('Manus left shape:', f['teleop/manus_left'].shape)
"
```

---

## 与训练框架兼容性

### ACT (Action Chunking with Transformers)

```python
from act.data import EpisodeDataset

dataset = EpisodeDataset(
    data_dir='/data/teleop_episodes',
    camera_names=['head_left', 'head_right', 'wrist_left', 'wrist_right'],
    action_dim=54,  # 14 (arm) + 40 (hand)
    chunk_size=100,
)
```

### Diffusion Policy

```python
# HDF5 → Zarr 转换后使用
from diffusion_policy.dataset import RobomimicLowdimDataset

dataset = RobomimicLowdimDataset(
    dataset_path='teleop_data.zarr',
    obs_keys=['arm_qpos', 'hand_qpos'],
    action_keys=['arm_action', 'hand_action'],
)
```

---

## 总结

| 维度 | 配置 |
|------|------|
| **输入自由度** | 4x6DoF (Trackers) + 2x21DoF (Manus) = **66 DoF** |
| **输出自由度** | 2x7DoF (Arms) + 2x20DoF (Hands) = **54 DoF** |
| **相机数量** | 4 (头部左右 + 腕部左右) |
| **采集频率** | 30 Hz (同步输出) |
| **存储格式** | HDF5 (ACT/Diffusion Policy 兼容) |
| **时间同步** | message_filters (50ms slop) |
