# StereoVR - USB åŒç›®ç«‹ä½“è§†è§‰ VR æµåª’ä½“åº“

<div align="center">

**å®æ—¶åŒç›®è§†è§‰ â†’ VR å¤´æ˜¾**

[![Python 3.8+](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

</div>

---

## æ¦‚è¿°

StereoVR æ˜¯ä¸€ä¸ª USB åŒç›®ç›¸æœºæµåª’ä½“åº“ï¼Œæ”¯æŒå°†åŒç›®è§†é¢‘å®æ—¶ä¼ è¾“åˆ° VR å¤´æ˜¾ï¼Œé€‚ç”¨äº:

- ğŸ¤– **æœºå™¨äººé¥æ“ä½œ** - è¿œç¨‹æ§åˆ¶æ—¶çš„ç¬¬ä¸€äººç§°è§†è§’
- ğŸ® **VR é€è§†** - å°†çœŸå®ä¸–ç•ŒæŠ•å°„åˆ° VR ä¸­
- ğŸ”¬ **ç«‹ä½“è§†è§‰ç ”ç©¶** - åŒç›®è§†è§‰ç®—æ³•å¼€å‘

### æ”¯æŒçš„ä¼ è¾“æ¨¡å¼

| ç‰¹æ€§ | WebSocket æ¨¡å¼ | XRoboToolkit æ¨¡å¼ | V4L2 Loopback æ¨¡å¼ |
|------|----------------|-------------------|-------------------|
| åè®® | WSS (Base64 JPEG) | TCP H.264 (NVENC) | MJPEG â†’ V4L2 |
| å»¶è¿Ÿ | ~80-150ms | **~30-50ms** | ~40-60ms |
| å®¢æˆ·ç«¯ | ä»»æ„ WebXR æµè§ˆå™¨ | XRoboToolkit Unity | ROS2 / OpenCV |
| è®¾å¤‡æ”¯æŒ | Quest/PICO/Vision Pro | PICO | ä»»æ„ Linux åº”ç”¨ |
| é€‚ç”¨åœºæ™¯ | æ¼”ç¤º/è°ƒè¯• | **é¥æ“ä½œ(æ¨è)** | **ROS2 æœºå™¨äººæ„ŸçŸ¥** |
| è¿æ¥æ–¹å¼ | WiFi | USB ADB / WiFi | USB æœ‰çº¿ |
| ROS2 é›†æˆ | å¦ | å¦ | **æ˜¯** |

---

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install opencv-python numpy websockets

# XRoboToolkit æ¨¡å¼è¿˜éœ€è¦ FFmpeg:
# Ubuntu: sudo apt install ffmpeg
# Windows: ä¸‹è½½ ffmpeg.org å¹¶æ·»åŠ åˆ° PATH
```

### æ–¹å¼ä¸€: WebSocket æ¨¡å¼ (WebXR)

```bash
python start.py
```

åœ¨ VR æµè§ˆå™¨è®¿é—® `https://ä½ çš„IP:8445`

### æ–¹å¼äºŒ: XRoboToolkit æ¨¡å¼ (ä½å»¶è¿Ÿé¥æ“ä½œ)

```bash
python start_xrobo_compat.py
```

åœ¨ PICO çš„ XRoboToolkit Client ä¸­:
1. é€‰æ‹©è§†é¢‘æº `USB_STEREO`
2. è¾“å…¥ PC IP åœ°å€
3. ç‚¹å‡» Listen

### æ–¹å¼ä¸‰: V4L2 Loopback åŒè¿›ç¨‹æ¶æ„ (ROS2 å‘å¸ƒ)

V4L2 (Video4Linux2) æ˜¯ Linux çš„è§†é¢‘è®¾å¤‡æ ‡å‡† APIã€‚é€šè¿‡ V4L2 Loopbackï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç›¸æœºè®¾å¤‡ï¼Œå°†è§†é¢‘æµè¾“å‡ºåˆ°å…¶ä»–åº”ç”¨ç¨‹åºã€‚

**æ¶æ„ä¼˜åŠ¿:**
- è¿›ç¨‹éš”ç¦»: ROS2 å‘å¸ƒå®Œå…¨ç‹¬ç«‹ï¼Œä¸å½±å“ PICO è§†é¢‘æµå»¶è¿Ÿ
- èµ„æºç‹¬ç«‹: å„è‡ªæœ‰ç‹¬ç«‹çš„ CPU/GPU èµ„æºåˆ†é…
- æ•…éšœéš”ç¦»: ROS2 è¿›ç¨‹å´©æºƒä¸å½±å“ PICO å®æ—¶è§†é¢‘æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›ç¨‹ 1: PICO è§†é¢‘æµ (é«˜ä¼˜å…ˆçº§)                                           â”‚
â”‚  /dev/stereo_camera â†’ FFmpeg â†’ H.264 â†’ TCP â†’ PICO (60fps)            â”‚
â”‚              â†“                                                           â”‚
â”‚         MJPEG â†’ /dev/video99 (30fps)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                  V4L2 Loopback
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿›ç¨‹ 2: ROS2 å‘å¸ƒ (ç‹¬ç«‹è¿›ç¨‹)                                             â”‚
â”‚  /dev/video99 â†’ OpenCV â†’ å·¦å³åˆ†å‰² â†’ CompressedImage                     â”‚
â”‚                                    â”œâ”€ /stereo/left/compressed           â”‚
â”‚                                    â””â”€ /stereo/right/compressed          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¯åŠ¨æ­¥éª¤:**

```bash
# 1. åŠ è½½ v4l2loopback æ¨¡å— (éœ€è¦ root æƒé™)
sudo modprobe v4l2loopback video_nr=99 card_label="StereoVR_ROS2"

# 2. å¯åŠ¨ä¸»æœåŠ¡å™¨ (è¾“å‡ºåˆ° loopback è®¾å¤‡)
python start_xrobo_compat.py --device /dev/stereo_camera --loopback /dev/video99 --loopback-fps 30

# 3. åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨ ROS2 å‘å¸ƒ
python -m teleopVision.ros2_loopback_publisher --device /dev/video99 --fps 30

# 4. éªŒè¯ ROS2 è¯é¢˜
ros2 topic list | grep stereo
ros2 topic hz /stereo/left/compressed
```

**ä½¿ç”¨ UDEV è§„åˆ™å›ºå®šè®¾å¤‡åç§°:**

åŒç›®ç›¸æœºè®¾å¤‡ä¿¡æ¯:
- **Vendor ID:** `1bcf` (Sunplus Innovation Technology)
- **Product ID:** `2d4f`
- **è®¾å¤‡åç§°:** USB2.0 Camera

ä¸ºé¿å…è®¾å¤‡ç¼–å·å˜åŒ–ï¼Œåˆ›å»º `/etc/udev/rules.d/99-stereo-camera.rules`:

```bash
# åˆ›å»º udev è§„åˆ™æ–‡ä»¶
sudo tee /etc/udev/rules.d/99-stereo-camera.rules << 'EOF'
# USB2.0 Camera RGB (åŒç›®ç›¸æœº) - å›ºå®šä¸º /dev/stereo_camera
# Vendor: 1bcf (Sunplus), Product: 2d4f
SUBSYSTEM=="video4linux", ATTRS{idVendor}=="1bcf", ATTRS{idProduct}=="2d4f", ATTR{index}=="0", SYMLINK+="stereo_camera", MODE="0666"
EOF

# é‡æ–°åŠ è½½ udev è§„åˆ™
sudo udevadm control --reload-rules
sudo udevadm trigger

# éªŒè¯è®¾å¤‡é“¾æ¥
ls -la /dev/stereo_camera
readlink -f /dev/stereo_camera
```

ç°åœ¨å¯ä»¥ä½¿ç”¨å›ºå®šçš„è®¾å¤‡è·¯å¾„:

```bash
# å¯åŠ¨ä¸»æœåŠ¡å™¨ (ä½¿ç”¨å›ºå®šçš„ç¬¦å·é“¾æ¥)
python start_xrobo_compat.py --device /dev/stereo_camera --loopback /dev/video99 --loopback-fps 30

# é‡ç½®ç›¸æœºå‚æ•° (å¯é€‰)
v4l2-ctl -d /dev/stereo_camera --set-ctrl=brightness=0,contrast=3,auto_exposure=3
```

**ROS2 è¯é¢˜:**

| è¯é¢˜ | ç±»å‹ | å¸§ç‡ | è¯´æ˜ |
|------|------|------|------|
| `/stereo/left/compressed` | CompressedImage | 30fps | å·¦çœ¼å›¾åƒ (JPEG) |
| `/stereo/right/compressed` | CompressedImage | 30fps | å³çœ¼å›¾åƒ (JPEG) |

---

## åè®®åŸç†å¯¹æ¯”

### ä¸ºä»€ä¹ˆ UDP RTP H.264 å»¶è¿Ÿæ›´ä½ï¼Ÿ

#### WebSocket æ¨¡å¼çš„å»¶è¿Ÿåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket æ¨¡å¼ (æ€»å»¶è¿Ÿ ~80-150ms)                                       â”‚
â”‚                                                                          â”‚
â”‚  å‘é€ç«¯:                                                                  â”‚
â”‚  ç›¸æœºé‡‡é›† â†’ JPEG ç¼–ç  â†’ Base64 â†’ JSON å°è£… â†’ TCP/WebSocket               â”‚
â”‚    16ms      5-10ms     3-5ms      1ms        20-40ms                    â”‚
â”‚                                                                          â”‚
â”‚  æ¥æ”¶ç«¯:                                                                  â”‚
â”‚  WebSocket â†’ JSON è§£æ â†’ Base64 è§£ç  â†’ JPEG è§£ç  â†’ Canvas æ¸²æŸ“           â”‚
â”‚    1-5ms       1ms         2ms         5-10ms       16ms                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»¶è¿Ÿæ¥æº:**
1. **JPEG é€å¸§ç¼–ç ** - æ¯å¸§ç‹¬ç«‹å‹ç¼©ï¼Œæ— æ³•åˆ©ç”¨å¸§é—´å†—ä½™ï¼Œç¼–ç æ…¢
2. **Base64 å¼€é”€** - æ•°æ®é‡å¢åŠ  33%ï¼Œä¼ è¾“æ—¶é—´å¢åŠ 
3. **TCP é‡ä¼ ** - ä¸¢åŒ…éœ€è¦é‡ä¼ ï¼Œå¢åŠ å»¶è¿ŸæŠ–åŠ¨
4. **JS è§£ç ** - æµè§ˆå™¨ JavaScript è§£ç æ•ˆç‡è¾ƒä½

#### TCP H.264 æ¨¡å¼çš„å»¶è¿Ÿåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TCP H.264 æ¨¡å¼ (æ€»å»¶è¿Ÿ ~30-50ms)                                        â”‚
â”‚                                                                          â”‚
â”‚  å‘é€ç«¯ (PC):                                                            â”‚
â”‚  ç›¸æœºé‡‡é›† â†’ H.264 ç¡¬ç¼–ç (NVENC) â†’ TCP å‘é€                               â”‚
â”‚    16ms         1-3ms              <5ms                                  â”‚
â”‚                                                                          â”‚
â”‚  æ¥æ”¶ç«¯ (PICO):                                                          â”‚
â”‚  TCP æ¥æ”¶ â†’ H.264 ç¡¬è§£ç (MediaCodec) â†’ GPU çº¹ç†                          â”‚
â”‚    <5ms            1-2ms                <1ms                             â”‚
â”‚                                                                          â”‚
â”‚  æ¡æ‰‹åè®®:                                                               â”‚
â”‚  PICO â”€â”€OPEN_CAMERAâ”€â”€â†’ PC                                               â”‚
â”‚  PICO â†â”€â”€ TCP Connect â”€â”€ PC (å¯åŠ¨ FFmpeg ç¼–ç å™¨)                         â”‚
â”‚  PICO â”€â”€MEDIA_DECODER_READYâ”€â”€â†’ PC (å¼€å§‹å‘é€è§†é¢‘æµ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½å»¶è¿ŸåŸå› :**
1. **å¸§é—´å‹ç¼©** - H.264 åˆ©ç”¨å¸§é—´å†—ä½™ï¼ŒPå¸§åªå­˜å·®å¼‚ï¼Œç¼–ç å¿« 5-10 å€
2. **ç¡¬ä»¶åŠ é€Ÿ** - NVENC ç¼–ç  + MediaCodec è§£ç ï¼Œå»¶è¿Ÿæä½
3. **TCP å¯é ä¼ è¾“** - ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé€‚åˆæœ‰çº¿ USB è¿æ¥
4. **é›¶æ‹·è´** - è§£ç ç›´æ¥è¾“å‡ºåˆ° GPU çº¹ç†ï¼Œæ— å†…å­˜æ‹·è´

### H.264 å…³é”®å‚æ•°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GOP ç»“æ„ (å…³é”®å¸§é—´éš” = 15)                                              â”‚
â”‚                                                                         â”‚
â”‚   I â”€â”€â”€ P â”€â”€â”€ P â”€â”€â”€ P â”€â”€â”€ ... â”€â”€â”€ P â”€â”€â”€ I â”€â”€â”€ P â”€â”€â”€ ...                â”‚
â”‚   â”‚                               â”‚     â”‚                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€ 15 å¸§ (0.25ç§’@60fps) â”€â”€â”€â”˜     â”‚                               â”‚
â”‚                                          â”‚                               â”‚
â”‚  Iå¸§: å®Œæ•´å›¾åƒï¼Œå¯ç‹¬ç«‹è§£ç ï¼Œä½“ç§¯å¤§ (~50KB)                               â”‚
â”‚  På¸§: åªå­˜å‚¨å·®å¼‚ï¼Œä½“ç§¯å° (~5KB)                                          â”‚
â”‚                                                                         â”‚
â”‚  é¥æ“ä½œæ¨è:                                                             â”‚
â”‚  - GOP = 15-30 (ä¸¢åŒ…å 0.25-0.5 ç§’æ¢å¤)                                  â”‚
â”‚  - zerolatency (ç¦ç”¨ B å¸§)                                               â”‚
â”‚  - ultrafast (æœ€å¿«ç¼–ç )                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å»¶è¿Ÿæµ‹é‡å¯¹æ¯”

| ç¯èŠ‚ | WebSocket | TCP H.264 |
|------|-----------|---------------|
| ç›¸æœºé‡‡é›† | 16ms | 16ms |
| ç¼–ç  | 5-10ms | 1-3ms (NVENC) |
| ä¼ è¾“å°è£… | 4-6ms | <1ms |
| ç½‘ç»œä¼ è¾“ | 20-40ms | 5-15ms |
| æ¥æ”¶è§£ç  | 5-10ms | 1-2ms (MediaCodec) |
| æ¸²æŸ“ | 16ms | 8ms |
| **æ€»è®¡** | **66-98ms** | **32-45ms** |

---

## é€šä¿¡åè®®è¯¦è§£

### XRoboToolkit è§†é¢‘æµæ¡æ‰‹åè®®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸‰æ¬¡æ¡æ‰‹ç¡®ä¿æ­£ç¡®çš„åˆå§‹åŒ–é¡ºåº                                             â”‚
â”‚                                                                          â”‚
â”‚     PICO (Unity Client)              PC (Python Server)                  â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚â”€â”€â”€â”€ OPEN_CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                            â”‚
â”‚            â”‚     (width, height, fps,      â”‚                            â”‚
â”‚            â”‚      bitrate, ip, port)       â”‚                            â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚                   å¯åŠ¨ FFmpeg ç¼–ç å™¨                         â”‚
â”‚            â”‚                   è¿æ¥åˆ° PICO:port                          â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚ â†â”€â”€â”€â”€â”€ TCP è¿æ¥å»ºç«‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚     MediaDecoder åˆå§‹åŒ–        â”‚                            â”‚
â”‚            â”‚     (ç­‰å¾… 0.5s ç¡®ä¿å°±ç»ª)       â”‚                            â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚â”€â”€â”€â”€ MEDIA_DECODER_READY â”€â”€â”€â”€â†’ â”‚                            â”‚
â”‚            â”‚     (port)                     â”‚                            â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚ â†â”€â”€â”€â”€â”€â”€â”€ è§†é¢‘å¸§æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
â”‚            â”‚     (è¿ç»­ H.264 å¸§)            â”‚                            â”‚
â”‚            â”‚                                â”‚                            â”‚
â”‚            â”‚â”€â”€â”€â”€ CLOSE_CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  (å…³é—­æ—¶)                   â”‚
â”‚            â”‚                                â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åè®®å‘½ä»¤æ ¼å¼

```python
# NetworkDataProtocol ç»“æ„
{
    "command": str,      # å‘½ä»¤å (å¦‚ "OPEN_CAMERA")
    "length": int,       # æ•°æ®é•¿åº¦
    "data": bytes        # äºŒè¿›åˆ¶æ•°æ®
}

# åºåˆ—åŒ–æ ¼å¼: | command (32 bytes, null-padded) | length (4 bytes, little-endian) | data |
```

### å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | æ–¹å‘ | æ•°æ® | è¯´æ˜ |
|------|------|------|------|
| `OPEN_CAMERA` | PICO â†’ PC | CameraRequest JSON | è¯·æ±‚æ‰“å¼€ç›¸æœºæµ |
| `MEDIA_DECODER_READY` | PICO â†’ PC | port (4 bytes int) | é€šçŸ¥è§£ç å™¨å·²å°±ç»ª |
| `CLOSE_CAMERA` | PICO â†’ PC | ç©º | å…³é—­ç›¸æœºæµ |

---

## é¡¹ç›®ç»“æ„

```
StereoVR/
â”‚
â”œâ”€â”€ ğŸ“¦ teleopVision/                    # æ ¸å¿ƒ Python åŒ…
â”‚   â”œâ”€â”€ __init__.py                # åº“å…¥å£ï¼Œå¯¼å‡ºå…¬å…± API
â”‚   â”œâ”€â”€ config.py                  # é…ç½®ç®¡ç† (dataclass)
â”‚   â”œâ”€â”€ camera.py                  # ç›¸æœºé‡‡é›†æ¨¡å—
â”‚   â”œâ”€â”€ server.py                  # WebSocket æœåŠ¡å™¨
â”‚   â”œâ”€â”€ h264_sender.py             # H.264 ç¼–ç å™¨ (FFmpeg)
â”‚   â”œâ”€â”€ xrobo_compat_server.py     # XRoboToolkit å…¼å®¹æœåŠ¡å™¨
â”‚   â””â”€â”€ ros2_loopback_publisher.py # V4L2 Loopback ROS2 å‘å¸ƒå™¨
â”‚
â”œâ”€â”€ ğŸŒ web/                        # Web å‰ç«¯
â”‚   â”œâ”€â”€ index.html                 # ä¸»é¡µ
â”‚   â”œâ”€â”€ dual_infrared_viewer.html  # 2D åŒç›®æŸ¥çœ‹å™¨
â”‚   â””â”€â”€ dual_infrared_vr_viewer.html  # VR ç«‹ä½“æŸ¥çœ‹å™¨
â”‚
â”œâ”€â”€ ğŸ“– docs/                       # æ–‡æ¡£
â”‚   â”œâ”€â”€ QUICK_START.md             # å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ INTEGRATION_GUIDE.md       # XRoboToolkit é›†æˆæŒ‡å—
â”‚   â”œâ”€â”€ BODY_TRACKING_DESIGN.md    # èº«ä½“è¿½è¸ªè®¾è®¡
â”‚   â””â”€â”€ UNIFIED_TELEOP_SYSTEM.md   # ç»Ÿä¸€é¥æ“ä½œç³»ç»Ÿ
â”‚
â”œâ”€â”€ ğŸš€ start.py                    # WebSocket æ¨¡å¼å¯åŠ¨
â”œâ”€â”€ ğŸš€ start_xrobo_compat.py       # XRoboToolkit æ¨¡å¼å¯åŠ¨ (æ”¯æŒ V4L2 Loopback)
â””â”€â”€ README.md                      # é¡¹ç›®è¯´æ˜
```

---

## API ä½¿ç”¨

### ä½œä¸º Python åº“

```python
# é¥æ“ä½œåœºæ™¯ (ä½å»¶è¿Ÿ)
from teleopVision import start_xrobo_server
start_xrobo_server(device_id=0)

# WebXR åœºæ™¯
from teleopVision import start_websocket_server
start_websocket_server()
```

### è‡ªå®šä¹‰é…ç½®

```python
from teleopVision import CameraConfig, EncoderConfig, StereoVRConfig

config = StereoVRConfig(
    camera=CameraConfig(
        stereo_width=2560,
        stereo_height=720,
        fps=60
    ),
    encoder=EncoderConfig(
        bitrate=8_000_000,
        keyframe_interval=15  # çŸ­ GOPï¼Œå¿«é€Ÿæ¢å¤
    )
)
```

### ç›´æ¥ä½¿ç”¨ç›¸æœºæ¨¡å—

```python
from teleopVision import create_camera

camera = create_camera()
camera.start()

while True:
    frame = camera.get_frame()
    if frame:
        # frame.left_eye  - å·¦çœ¼å›¾åƒ
        # frame.right_eye - å³çœ¼å›¾åƒ
        cv2.imshow('Left', frame.left_eye)
```

---

## æ”¯æŒçš„ç›¸æœº

| å‹å· | ä¼ æ„Ÿå™¨ | åˆ†è¾¨ç‡ | å¸§ç‡ | åŸºçº¿ | è§†åœºè§’ |
|------|--------|--------|------|------|--------|
| HBVCAM-F2439GS-2 V11 | AR0234 | 2560x720 | 60fps | 60mm | 125Â° |

æ”¯æŒä»»ä½• UVC åŒç›®ç›¸æœº (å·¦å³å¹¶æ’è¾“å‡º)ã€‚

---

## é¥æ“ä½œä¼˜åŒ–å»ºè®®

### 1. é™ä½åˆ†è¾¨ç‡

```bash
python start_xrobo_compat.py --width 1920 --height 540
```

### 2. ä½¿ç”¨ USB æœ‰çº¿ (æ¨è)

USB æœ‰çº¿è¿æ¥å»¶è¿Ÿæœ€ä½ä¸”æœ€ç¨³å®šã€‚éœ€è¦è®¾ç½® ADB ç«¯å£è½¬å‘:

```bash
# è®¾ç½® ADB ç«¯å£è½¬å‘ (åœ¨ PC ä¸Šè¿è¡Œ)
adb reverse tcp:63901 tcp:63901   # XRoboToolkit æ§åˆ¶é€šé“
adb forward tcp:12345 tcp:12345   # è§†é¢‘æµç«¯å£ (PC â†’ PICO)

# éªŒè¯ç«¯å£è½¬å‘
adb reverse --list
adb forward --list
```

**å·¥ä½œåŸç†:**
- `adb reverse`: è®© PICO è®¿é—® `localhost:63901` æ—¶è½¬å‘åˆ° PC çš„ 63901 ç«¯å£
- `adb forward`: è®© PC è®¿é—® `localhost:12345` æ—¶è½¬å‘åˆ° PICO çš„ 12345 ç«¯å£

**è¿æ¥æµç¨‹:**
```
PICO (localhost:63901) â†â”€â”€reverseâ”€â”€â†’ PC (0.0.0.0:63901)  # æ§åˆ¶å‘½ä»¤
PC (localhost:12345)   â†â”€â”€forwardâ”€â”€â†’ PICO (12345)        # è§†é¢‘æµ
```

### 3. ä½¿ç”¨ 5GHz WiFi

2.4GHz å»¶è¿Ÿé«˜ä¸”ä¸ç¨³å®šã€‚

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆç”¨ TCP è€Œä¸æ˜¯ UDPï¼Ÿ

XRoboToolkit æ¨¡å¼ä½¿ç”¨ TCP æ˜¯å› ä¸º:
1. **USB ADB è½¬å‘** - ADB ç«¯å£è½¬å‘å¯¹ TCP æ”¯æŒæ›´å¥½ï¼ŒUDP å¯èƒ½æœ‰é—®é¢˜
2. **å¯é æ€§** - æœ‰çº¿ USB è¿æ¥ä¸‹ TCP é‡ä¼ å¼€é”€æå°
3. **Android MediaCodec** - PICO çš„è§£ç å™¨éœ€è¦å®Œæ•´çš„ H.264 å¸§

åœ¨çº¯ WiFi åœºæ™¯ä¸‹ï¼ŒUDP å¯èƒ½å»¶è¿Ÿæ›´ä½ï¼Œä½†ä¼šæœ‰ç”»é¢æ’•è£‚ã€‚

### Q: ç¬¬ä¸€æ¬¡è¿æ¥å¤±è´¥ "Broken pipe" æ€ä¹ˆåŠï¼Ÿ

è¿™é€šå¸¸æ˜¯å› ä¸º MEDIA_DECODER_READY ä¿¡å·æœªæ­£ç¡®å‘é€ã€‚æ£€æŸ¥:
1. Unity å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®ç­‰å¾… MediaDecoder åˆå§‹åŒ– (0.5 ç§’)
2. Python æœåŠ¡å™¨æ˜¯å¦æ­£ç¡®å¤„ç† MEDIA_DECODER_READY å‘½ä»¤

### Q: zerolatency æ˜¯ä»€ä¹ˆï¼Ÿ

ç¦ç”¨ B å¸§å’Œå‰ç»åˆ†æï¼Œå‡å°‘ç¼–ç ç¼“å†²ï¼Œé™ä½å»¶è¿Ÿã€‚

### Q: å¦‚ä½•æµ‹é‡å»¶è¿Ÿï¼Ÿ

åœ¨ç›¸æœºå‰æ”¾ç½®æ¯«ç§’è®¡æ—¶å™¨ï¼Œæ‹æ‘„ VR ç”»é¢ï¼Œå¯¹æ¯”æ—¶é—´å·®ã€‚

---

## ä½œè€…

**Liang ZHU** - lzhu686@connect.hkust-gz.edu.cn

é¦™æ¸¯ç§‘æŠ€å¤§å­¦ (å¹¿å·)

## è®¸å¯è¯

MIT License
